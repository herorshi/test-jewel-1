"use client";
import { useEffect, useRef, useState } from "react";

// ‡πÄ‡∏û‡∏¥‡πà‡∏° type ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö action history
const ACTION_TYPES = {
  ADD_MARKER: "ADD_MARKER",
  REMOVE_MARKER: "REMOVE_MARKER",
  MOVE_MARKER: "MOVE_MARKER",
  RESET_MARKER: "RESET_MARKER",
  ADD_ZONE: "ADD_ZONE",
  REMOVE_ZONE: "REMOVE_ZONE",
  EDIT_MARKER: "EDIT_MARKER",
  EDIT_ZONE: "EDIT_ZONE",
  MOVE_GROUP: "MOVE_GROUP",
  MOVE_ZONE_GROUP: "MOVE_ZONE_GROUP",
  MOVE_MIXED_GROUP: "MOVE_MIXED_GROUP"
};

export default function VillageMap() {
  const [markers, setMarkers] = useState([]);
  const [zones, setZones] = useState([]);
  const [showPopup, setShowPopup] = useState(false);
  const [showZoneModal, setShowZoneModal] = useState(false);
  const [showEditMarkerModal, setShowEditMarkerModal] = useState(false);
  const [isLoading, setIsLoading] = useState(true);
  const [currentPosition, setCurrentPosition] = useState({ x: 0, y: 0 });
  const [formData, setFormData] = useState({ name: "", group: "", color: "red" });
  const [editMarkerData, setEditMarkerData] = useState(null);
  const [originalMarkerData, setOriginalMarkerData] = useState(null);
  const [zoneFormData, setZoneFormData] = useState({ name: "", color: "blue" });
  const [selectedZoneShape, setSelectedZoneShape] = useState("rectangle");
  const [draggedMarker, setDraggedMarker] = useState(null);
  const [isDragging, setIsDragging] = useState(false);
  const [isSelectingZone, setIsSelectingZone] = useState(false);
  const [selectionStart, setSelectionStart] = useState(null);
  const [selectionEnd, setSelectionEnd] = useState(null);
  const [currentSelection, setCurrentSelection] = useState(null);
  const [mouseDownStart, setMouseDownStart] = useState(null);
  const [mouseDownTime, setMouseDownTime] = useState(null);
  const [hasDragged, setHasDragged] = useState(false);
  const [visibleZones, setVisibleZones] = useState({});
  const [draggedZone, setDraggedZone] = useState(null);
  const [isDraggingZone, setIsDraggingZone] = useState(false);
  const [isResizingZone, setIsResizingZone] = useState(false);
  const [isRotatingZone, setIsRotatingZone] = useState(false);
  const [resizeHandle, setResizeHandle] = useState(null);
  const [originalZoneState, setOriginalZoneState] = useState(null);
  const [rotationStartAngle, setRotationStartAngle] = useState(0);
  const [draggedListMarker, setDraggedListMarker] = useState(null);
  const [dragOverZoneId, setDragOverZoneId] = useState(null);
  const [markerSizes, setMarkerSizes] = useState({});
  const imageRef = useRef(null);
  const [showEditZoneModal, setShowEditZoneModal] = useState(false);
  const [editZoneData, setEditZoneData] = useState(null);
  const [originalZoneData, setOriginalZoneData] = useState(null);
  // ‡πÄ‡∏û‡∏¥‡πà‡∏° state ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏Å‡πá‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥
  const [history, setHistory] = useState([]);
  const [currentIndex, setCurrentIndex] = useState(-1);
  // ‡πÄ‡∏û‡∏¥‡πà‡∏° state ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏Å‡πá‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏´‡∏ß
  const [moveHistory, setMoveHistory] = useState([]);
  const [currentMoveIndex, setCurrentMoveIndex] = useState(-1);
  // ‡πÄ‡∏û‡∏¥‡πà‡∏° state ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö‡∏Å‡∏•‡∏∏‡πà‡∏°
  const [isGroupSelecting, setIsGroupSelecting] = useState(false);
  const [selectedMarkers, setSelectedMarkers] = useState([]);
  const [selectedZones, setSelectedZones] = useState([]);
  const [groupSelectionStart, setGroupSelectionStart] = useState(null);
  const [groupSelectionEnd, setGroupSelectionEnd] = useState(null);
  const [isDraggingGroup, setIsDraggingGroup] = useState(false);
  const [isDraggingZoneGroup, setIsDraggingZoneGroup] = useState(false);
  const [isDraggingMixed, setIsDraggingMixed] = useState(false);
  const [groupDragOffset, setGroupDragOffset] = useState({ x: 0, y: 0 });
  const [dragReference, setDragReference] = useState(null);
  const [justFinishedGroupSelection, setJustFinishedGroupSelection] = useState(false);
  // ‡πÄ‡∏û‡∏¥‡πà‡∏° state ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö zoom
  const [zoomLevel, setZoomLevel] = useState(1);
  const [panOffset, setPanOffset] = useState({ x: 0, y: 0 });
  const [isPanning, setIsPanning] = useState(false);
  const [panStart, setPanStart] = useState({ x: 0, y: 0 });
  const [isCtrlPressed, setIsCtrlPressed] = useState(false);
  const containerRef = useRef(null);

  // ‡∏™‡∏µ‡πÅ‡∏•‡∏∞‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏µ
  const colorOptions = [
    { value: "red", label: "‡πÅ‡∏î‡∏á", bg: "bg-red-500", hover: "hover:bg-red-600" },
    { value: "yellow", label: "‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á", bg: "bg-yellow-500", hover: "hover:bg-yellow-600" },
    { value: "green", label: "‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß", bg: "bg-green-500", hover: "hover:bg-green-600" },
    { value: "blue", label: "‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô", bg: "bg-blue-500", hover: "hover:bg-blue-600" },
    { value: "pink", label: "‡∏ä‡∏°‡∏û‡∏π", bg: "bg-pink-500", hover: "hover:bg-pink-600" },
    { value: "indigo", label: "‡∏Ñ‡∏£‡∏≤‡∏°", bg: "bg-indigo-500", hover: "hover:bg-indigo-600" },
    { value: "teal", label: "‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏´‡∏±‡∏ß‡πÄ‡∏õ‡πá‡∏î", bg: "bg-teal-500", hover: "hover:bg-teal-600" }
  ];

  const zoneColorOptions = [
    { value: "blue", label: "‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô", bg: "bg-blue-500", border: "border-blue-500", bgOpacity: "bg-blue-200" },
    { value: "purple", label: "‡∏°‡πà‡∏ß‡∏á", bg: "bg-purple-500", border: "border-purple-500", bgOpacity: "bg-purple-200" },
    { value: "orange", label: "‡∏™‡πâ‡∏°", bg: "bg-orange-500", border: "border-orange-500", bgOpacity: "bg-orange-200" },
    { value: "emerald", label: "‡∏°‡∏£‡∏Å‡∏ï", bg: "bg-emerald-500", border: "border-emerald-500", bgOpacity: "bg-emerald-200" },
    { value: "rose", label: "‡∏Å‡∏∏‡∏´‡∏•‡∏≤‡∏ö", bg: "bg-rose-500", border: "border-rose-500", bgOpacity: "bg-rose-200" },
    { value: "cyan", label: "‡∏ü‡πâ‡∏≤", bg: "bg-cyan-500", border: "border-cyan-500", bgOpacity: "bg-cyan-200" },
    { value: "amber", label: "‡∏≠‡∏≥‡∏û‡∏±‡∏ô", bg: "bg-amber-500", border: "border-amber-500", bgOpacity: "bg-amber-200" }
  ];

  // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏ó‡∏£‡∏á zone
  const zoneShapeOptions = [
    { value: "rectangle", label: "", icon: "‚¨õ" },
    { value: "circle", label: "", icon: "üîµ" },
    { value: "triangle", label: "", icon: "üî∫" }
  ];

  // ‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥‡∏ó‡∏µ‡πà‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏≤‡∏Å (pixels)
  const DRAG_THRESHOLD = 5;

  // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏Ç‡∏ô‡∏≤‡∏î marker
  const DEFAULT_MARKER_SIZE = 6; // ‡∏Ç‡∏ô‡∏≤‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô 24px (6 * 4)
  const MIN_MARKER_SIZE = 1; // ‡∏Ç‡∏ô‡∏≤‡∏î‡∏ï‡πà‡∏≥‡∏™‡∏∏‡∏î 16px
  const MAX_MARKER_SIZE = 16; // ‡∏Ç‡∏ô‡∏≤‡∏î‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 48px

  // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏à‡∏∏‡∏î‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
  const isPointInZone = (x, y, zone) => {
    const { shape = "rectangle", x: zx, y: zy, width, height } = zone;

    switch (shape) {
      case "circle":
        // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ß‡∏á‡∏Å‡∏•‡∏°: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡∏à‡∏≤‡∏Å‡∏à‡∏∏‡∏î‡∏Å‡∏∂‡πà‡∏á‡∏Å‡∏•‡∏≤‡∏á
        const centerX = zx + width / 2;
        const centerY = zy + height / 2;
        const radiusX = width / 2;
        const radiusY = height / 2;
        const dx = (x - centerX) / radiusX;
        const dy = (y - centerY) / radiusY;
        return dx * dx + dy * dy <= 1;

      case "triangle":
        // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏≤‡∏°‡πÄ‡∏´‡∏•‡∏µ‡πà‡∏¢‡∏°: ‡πÉ‡∏ä‡πâ point-in-triangle algorithm
        const x1 = zx + width / 2; // ‡∏à‡∏∏‡∏î‡∏¢‡∏≠‡∏î‡∏ö‡∏ô
        const y1 = zy;
        const x2 = zx; // ‡∏à‡∏∏‡∏î‡∏ã‡πâ‡∏≤‡∏¢‡∏•‡πà‡∏≤‡∏á
        const y2 = zy + height;
        const x3 = zx + width; // ‡∏à‡∏∏‡∏î‡∏Ç‡∏ß‡∏≤‡∏•‡πà‡∏≤‡∏á
        const y3 = zy + height;

        const sign = (px, py, ax, ay, bx, by) => {
          return (px - bx) * (ay - by) - (ax - bx) * (py - by);
        };

        const d1 = sign(x, y, x1, y1, x2, y2);
        const d2 = sign(x, y, x2, y2, x3, y3);
        const d3 = sign(x, y, x3, y3, x1, y1);

        const hasNeg = d1 < 0 || d2 < 0 || d3 < 0;
        const hasPos = d1 > 0 || d2 > 0 || d3 > 0;

        return !(hasNeg && hasPos);

      default:
        // rectangle
        return x >= zx && x <= zx + width && y >= zy && y <= zy + height;
    }
  };

  // ‡∏´‡∏≤‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà marker ‡∏≠‡∏¢‡∏π‡πà
  const findMarkerZone = marker => {
    return zones.find(zone => isPointInZone(marker.x, marker.y, zone));
  };

  // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏™‡∏≠‡∏á‡∏à‡∏∏‡∏î
  const getDistance = (point1, point2) => {
    const dx = point1.x - point2.x;
    const dy = point1.y - point2.y;
    return Math.sqrt(dx * dx + dy * dy);
  };

  // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏Ç‡∏≠‡∏á marker ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô
  useEffect(
    () => {
      setMarkers(prevMarkers =>
        prevMarkers.map(marker => {
          const zone = findMarkerZone(marker);
          return zone ? { ...marker, group: zone.name } : marker;
        })
      );
    },
    [zones]
  );

  // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏´‡πâ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏™‡∏î‡∏á
  useEffect(
    () => {
      const newVisibleZones = {};
      zones.forEach(zone => {
        if (visibleZones[zone.id] === undefined) {
          newVisibleZones[zone.id] = true;
        }
      });
      setVisibleZones({ ...visibleZones, ...newVisibleZones });
    },
    [zones]
  );

  // ‡∏´‡∏≤‡∏à‡∏∏‡∏î‡∏Å‡∏∂‡πà‡∏á‡∏Å‡∏•‡∏≤‡∏á‡∏Ç‡∏≠‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏°
  const getZoneCenter = zone => {
    return {
      x: zone.x + zone.width / 2,
      y: zone.y + zone.height / 2
    };
  };

  // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏†‡∏≤‡∏û (‡∏™‡∏£‡πâ‡∏≤‡∏á marker)
  const handleImageClick = e => {
    if (
      isDragging ||
      hasDragged ||
      isGroupSelecting ||
      isDraggingGroup ||
      isDraggingZoneGroup ||
      isDraggingMixed ||
      selectedMarkers.length > 0 ||
      selectedZones.length > 0 ||
      justFinishedGroupSelection
    ) {
      setHasDragged(false);
      setJustFinishedGroupSelection(false);
      return;
    }

    // ‡πÅ‡∏õ‡∏•‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÄ‡∏°‡∏≤‡∏™‡πå‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ö‡∏ô‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà zoom ‡πÅ‡∏•‡πâ‡∏ß
    const rect = imageRef.current.getBoundingClientRect();
    const containerRect = containerRef.current.getBoundingClientRect();
    const mouseX = e.clientX - containerRect.left;
    const mouseY = e.clientY - containerRect.top;

    // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏à‡∏£‡∏¥‡∏á‡∏ö‡∏ô‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û
    const x = (mouseX - panOffset.x) / zoomLevel;
    const y = (mouseY - panOffset.y) / zoomLevel;

    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏Ç‡∏≠‡∏ö‡πÄ‡∏Ç‡∏ï‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    const imageWidth = rect.width / zoomLevel;
    const imageHeight = rect.height / zoomLevel;
    if (x < 0 || x > imageWidth || y < 0 || y > imageHeight) {
      return;
    }

    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏Ñ‡∏•‡∏¥‡∏Å‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÉ‡∏î‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    const clickedZone = zones.find(zone => !zone.isDefault && isPointInZone(x, y, zone));

    setCurrentPosition({ x, y });
    setShowPopup(true);
    setFormData({
      name: "",
      group: clickedZone ? clickedZone.name : "Marker",
      color: "red"
    });
  };

  // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥
  const addToHistory = (actionType, data) => {
    const newAction = {
      type: actionType,
      data: data,
      timestamp: Date.now()
    };

    // ‡∏ï‡∏±‡∏î‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏´‡∏•‡∏±‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏≠‡∏≠‡∏Å
    const newHistory = history.slice(0, currentIndex + 1);

    setHistory([...newHistory, newAction]);
    setCurrentIndex(currentIndex + 1);
  };

  // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô undo
  const undo = () => {
    if (currentIndex >= 0) {
      const action = history[currentIndex];

      switch (action.type) {
        case ACTION_TYPES.ADD_MARKER:
          setMarkers(markers.filter(m => m.id !== action.data.id));
          break;
        case ACTION_TYPES.REMOVE_MARKER:
          setMarkers([...markers, action.data]);
          break;
        case ACTION_TYPES.MOVE_MARKER:
          setMarkers(
            markers.map(m => (m.id === action.data.id ? { ...m, x: action.data.previousX, y: action.data.previousY } : m))
          );
          break;
        case ACTION_TYPES.RESET_MARKER:
          setMarkers(markers.map(m => (m.id === action.data.id ? { ...m, x: action.data.x, y: action.data.y } : m)));
          break;
        case ACTION_TYPES.ADD_ZONE:
          setZones(zones.filter(z => z.id !== action.data.id));
          break;
        case ACTION_TYPES.REMOVE_ZONE:
          setZones([...zones, action.data]);
          break;
        case ACTION_TYPES.EDIT_ZONE:
          setZones(zones.map(z => (z.id === action.data.id ? { ...z, ...action.data.previous } : z)));
          break;
        case ACTION_TYPES.EDIT_MARKER:
          setMarkers(markers.map(m => (m.id === action.data.id ? { ...m, ...action.data.previous } : m)));
          break;
        case ACTION_TYPES.MOVE_GROUP:
          setMarkers(
            markers.map(marker => {
              const originalMarker = action.data.markers.find(m => m.id === marker.id);
              if (originalMarker) {
                return {
                  ...marker,
                  x: originalMarker.originalX,
                  y: originalMarker.originalY
                };
              }
              return marker;
            })
          );
          break;
        case ACTION_TYPES.MOVE_ZONE_GROUP:
          setZones(
            zones.map(zone => {
              const originalZone = action.data.zones.find(z => z.id === zone.id);
              if (originalZone) {
                return {
                  ...zone,
                  x: originalZone.originalX,
                  y: originalZone.originalY
                };
              }
              return zone;
            })
          );
          break;
        case ACTION_TYPES.MOVE_MIXED_GROUP:
          // undo ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö markers
          if (action.data.markers) {
            setMarkers(
              markers.map(marker => {
                const originalMarker = action.data.markers.find(m => m.id === marker.id);
                if (originalMarker) {
                  return {
                    ...marker,
                    x: originalMarker.originalX,
                    y: originalMarker.originalY
                  };
                }
                return marker;
              })
            );
          }
          // undo ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö zones
          if (action.data.zones) {
            setZones(
              zones.map(zone => {
                const originalZone = action.data.zones.find(z => z.id === zone.id);
                if (originalZone) {
                  return {
                    ...zone,
                    x: originalZone.originalX,
                    y: originalZone.originalY
                  };
                }
                return zone;
              })
            );
          }
          break;
      }

      setCurrentIndex(currentIndex - 1);
    }
  };

  // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô redo
  const redo = () => {
    if (currentIndex < history.length - 1) {
      const nextIndex = currentIndex + 1;
      const action = history[nextIndex];

      switch (action.type) {
        case ACTION_TYPES.ADD_MARKER:
          setMarkers([...markers, action.data]);
          break;
        case ACTION_TYPES.REMOVE_MARKER:
          setMarkers(markers.filter(m => m.id !== action.data.id));
          break;
        case ACTION_TYPES.MOVE_MARKER:
          setMarkers(markers.map(m => (m.id === action.data.id ? { ...m, x: action.data.x, y: action.data.y } : m)));
          break;
        case ACTION_TYPES.RESET_MARKER:
          setMarkers(
            markers.map(m => (m.id === action.data.id ? { ...m, x: action.data.originalX, y: action.data.originalY } : m))
          );
          break;
        case ACTION_TYPES.ADD_ZONE:
          setZones([...zones, action.data]);
          break;
        case ACTION_TYPES.REMOVE_ZONE:
          setZones(zones.filter(z => z.id !== action.data.id));
          break;
        case ACTION_TYPES.EDIT_ZONE:
          setZones(zones.map(z => (z.id === action.data.id ? { ...z, ...action.data.current } : z)));
          break;
        case ACTION_TYPES.EDIT_MARKER:
          setMarkers(markers.map(m => (m.id === action.data.id ? { ...m, ...action.data.current } : m)));
          break;
        case ACTION_TYPES.MOVE_GROUP:
          setMarkers(
            markers.map(marker => {
              const movedMarker = action.data.markers.find(m => m.id === marker.id);
              if (movedMarker) {
                return {
                  ...marker,
                  x: movedMarker.currentX,
                  y: movedMarker.currentY
                };
              }
              return marker;
            })
          );
          break;
        case ACTION_TYPES.MOVE_ZONE_GROUP:
          setZones(
            zones.map(zone => {
              const movedZone = action.data.zones.find(z => z.id === zone.id);
              if (movedZone) {
                return {
                  ...zone,
                  x: movedZone.currentX,
                  y: movedZone.currentY
                };
              }
              return zone;
            })
          );
          break;
        case ACTION_TYPES.MOVE_MIXED_GROUP:
          // redo ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö markers
          if (action.data.markers) {
            setMarkers(
              markers.map(marker => {
                const movedMarker = action.data.markers.find(m => m.id === marker.id);
                if (movedMarker) {
                  return {
                    ...marker,
                    x: movedMarker.currentX,
                    y: movedMarker.currentY
                  };
                }
                return marker;
              })
            );
          }
          // redo ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö zones
          if (action.data.zones) {
            setZones(
              zones.map(zone => {
                const movedZone = action.data.zones.find(z => z.id === zone.id);
                if (movedZone) {
                  return {
                    ...zone,
                    x: movedZone.currentX,
                    y: movedZone.currentY
                  };
                }
                return zone;
              })
            );
          }
          break;
      }

      setCurrentIndex(nextIndex);
    }
  };

  // ‡πÄ‡∏û‡∏¥‡πà‡∏° useEffect ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ wheel event ‡∏ö‡∏ô container
  useEffect(
    () => {
      const container = containerRef.current;
      if (container) {
        // ‡πÄ‡∏û‡∏¥‡πà‡∏° passive: false ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ preventDefault ‡πÑ‡∏î‡πâ
        container.addEventListener("wheel", handleWheel, { passive: false });

        return () => {
          container.removeEventListener("wheel", handleWheel);
        };
      }
    },
    [zoomLevel, panOffset]
  );

  // ‡πÄ‡∏û‡∏¥‡πà‡∏° event listener ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö keyboard shortcuts
  useEffect(
    () => {
      const handleKeyDown = e => {
        if ((e.ctrlKey || e.metaKey) && e.key === "z" && !e.shiftKey) {
          e.preventDefault();
          undo();
        }
        if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key === "Z") {
          e.preventDefault();
          redo();
        }
        if (e.key === "Escape") {
          clearSelection();
        }
        // ‡πÄ‡∏û‡∏¥‡πà‡∏° shortcut ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï zoom
        if ((e.ctrlKey || e.metaKey) && e.key === "0") {
          e.preventDefault();
          resetZoomAndPan();
        }
        // ‡∏ï‡∏¥‡∏î‡∏ï‡∏≤‡∏° ctrl key
        if (e.ctrlKey || e.metaKey) {
          setIsCtrlPressed(true);
        }
      };

      const handleKeyUp = e => {
        if (!e.ctrlKey && !e.metaKey) {
          setIsCtrlPressed(false);
        }
      };

      window.addEventListener("keydown", handleKeyDown);
      window.addEventListener("keyup", handleKeyUp);
      return () => {
        window.removeEventListener("keydown", handleKeyDown);
        window.removeEventListener("keyup", handleKeyUp);
      };
    },
    [currentIndex, history]
  );

  // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á state
  const handleSubmit = e => {
    e.preventDefault();
    if (formData.name) {
      const newMarker = {
        id: Date.now(),
        x: currentPosition.x,
        y: currentPosition.y,
        originalX: currentPosition.x,
        originalY: currentPosition.y,
        name: formData.name,
        group: formData.group,
        color: formData.color
      };

      setMarkers([...markers, newMarker]);
      addToHistory(ACTION_TYPES.ADD_MARKER, newMarker);

      setShowPopup(false);
      setFormData({ name: "", group: "", color: "red" });
    }
  };

  const handleZoneSubmit = e => {
    e.preventDefault();

    if (zoneFormData.name && currentSelection) {
      const x = Math.min(currentSelection.startX, currentSelection.endX);
      const y = Math.min(currentSelection.startY, currentSelection.endY);
      const width = Math.abs(currentSelection.endX - currentSelection.startX);
      const height = Math.abs(currentSelection.endY - currentSelection.startY);

      const newZone = {
        id: Date.now(),
        name: zoneFormData.name,
        color: zoneFormData.color,
        shape: selectedZoneShape,
        x: x,
        y: y,
        width: width,
        height: height,
        rotation: 0,
        // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÄ‡∏î‡∏¥‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï
        originalX: x,
        originalY: y,
        originalWidth: width,
        originalHeight: height,
        originalRotation: 0
      };

      setZones([...zones, newZone]);
      addToHistory(ACTION_TYPES.ADD_ZONE, newZone);
      setShowZoneModal(false);
      setZoneFormData({ name: "", color: "blue" });
      // ‡πÑ‡∏°‡πà‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï selectedZoneShape ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏Ñ‡∏á‡∏£‡∏π‡∏õ‡∏ó‡∏£‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÑ‡∏ß‡πâ
      setVisibleZones({ ...visibleZones, [newZone.id]: true });
    }
  };

  const removeMarker = markerId => {
    const markerToRemove = markers.find(m => m.id === markerId);
    if (markerToRemove) {
      setMarkers(markers.filter(marker => marker.id !== markerId));
      addToHistory(ACTION_TYPES.REMOVE_MARKER, markerToRemove);
    }
  };

  const removeZone = zoneId => {
    const zoneToRemove = zones.find(z => z.id === zoneId);
    if (zoneToRemove) {
      setZones(zones.filter(zone => zone.id !== zoneId));
      addToHistory(ACTION_TYPES.REMOVE_ZONE, zoneToRemove);
    }
  };

  // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏õ‡∏¥‡∏î popup ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤
  const closePopup = () => {
    setShowPopup(false);
    setFormData({ name: "", group: "", color: "red" });
  };

  // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏õ‡∏¥‡∏î zone modal ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤
  const closeZoneModal = () => {
    setShowZoneModal(false);
    setZoneFormData({ name: "", color: "blue" });
    // ‡πÑ‡∏°‡πà‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï selectedZoneShape ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏Ñ‡∏á‡∏£‡∏π‡∏õ‡∏ó‡∏£‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÑ‡∏ß‡πâ
  };

  // reset marker ‡∏Å‡∏•‡∏±‡∏ö‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÄ‡∏î‡∏¥‡∏°
  const resetMarkerPosition = markerId => {
    setMarkers(prevMarkers =>
      prevMarkers.map(marker =>
        marker.id === markerId
          ? {
              ...marker,
              x: marker.originalX,
              y: marker.originalY,
              group: findMarkerZone({ x: marker.originalX, y: marker.originalY })?.name || "Marker"
            }
          : marker
      )
    );
  };

  // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á zone
  const resetZonePosition = zoneId => {
    const zone = zones.find(z => z.id === zoneId);
    if (zone && zone.originalX !== undefined && zone.originalY !== undefined) {
      // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á
      addToHistory(ACTION_TYPES.EDIT_ZONE, {
        id: zoneId,
        previous: {
          x: zone.x,
          y: zone.y,
          width: zone.width,
          height: zone.height,
          rotation: zone.rotation || 0
        },
        current: {
          x: zone.originalX,
          y: zone.originalY,
          width: zone.originalWidth || zone.width,
          height: zone.originalHeight || zone.height,
          rotation: zone.originalRotation || 0
        }
      });

      setZones(prevZones =>
        prevZones.map(z =>
          z.id === zoneId
            ? {
                ...z,
                x: z.originalX || z.x,
                y: z.originalY || z.y,
                width: z.originalWidth || z.width,
                height: z.originalHeight || z.height,
                rotation: z.originalRotation || 0
              }
            : z
        )
      );
    }
  };

  // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£ double click ‡∏ó‡∏µ‡πà marker
  const handleMarkerDoubleClick = (e, marker) => {
    e.preventDefault();
    e.stopPropagation();

    const markerData = {
      id: marker.id,
      name: marker.name,
      group: marker.group || "Marker",
      color: marker.color,
      size: markerSizes[marker.id] || DEFAULT_MARKER_SIZE,
      x: marker.x,
      y: marker.y
    };

    setOriginalMarkerData(markerData);
    setEditMarkerData(markerData);
    setShowEditMarkerModal(true);
  };

  // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£ mouse down ‡∏ó‡∏µ‡πà marker
  const handleMarkerMouseDown = (e, marker) => {
    // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô double click ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏•‡∏≤‡∏Å
    if (e.detail === 2) {
      return;
    }

    // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏≤‡∏Å‡∏ñ‡πâ‡∏≤‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥ group selection
    if (isGroupSelecting) {
      return;
    }

    e.preventDefault();
    e.stopPropagation();

    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ marker ‡∏ô‡∏µ‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    if (selectedMarkers.includes(marker.id) && selectedMarkers.length > 0) {
      // ‡∏ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏Å‡∏≤‡∏£‡∏•‡∏≤‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÅ‡∏ó‡∏ô
      const rect = imageRef.current.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;

      // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏ó‡∏±‡πâ‡∏á markers ‡πÅ‡∏•‡∏∞ zones ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ß‡πâ ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏Å‡∏≤‡∏£‡∏•‡∏≤‡∏Å‡πÅ‡∏ö‡∏ö‡∏ú‡∏™‡∏°
      if (selectedZones.length > 0) {
        // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å original positions ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á markers ‡πÅ‡∏•‡∏∞ zones
        setMarkers(prevMarkers =>
          prevMarkers.map(m => {
            if (selectedMarkers.includes(m.id)) {
              return { ...m, originalX: m.x, originalY: m.y };
            }
            return m;
          })
        );

        setZones(prevZones =>
          prevZones.map(zone => {
            if (selectedZones.includes(zone.id)) {
              return { ...zone, originalX: zone.x, originalY: zone.y };
            }
            return zone;
          })
        );

        setIsDraggingMixed(true);

        // ‡πÄ‡∏Å‡πá‡∏ö reference point ‡πÅ‡∏•‡∏∞ offset
        const referencePoint = { x: marker.x, y: marker.y, type: "marker", id: marker.id };
        setDragReference(referencePoint);
        setGroupDragOffset({
          x: x - marker.x,
          y: y - marker.y
        });
        return;
      }

      // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏â‡∏û‡∏≤‡∏∞ markers
      setMarkers(prevMarkers =>
        prevMarkers.map(m => {
          if (selectedMarkers.includes(m.id)) {
            return { ...m, originalX: m.x, originalY: m.y };
          }
          return m;
        })
      );

      setIsDraggingGroup(true);
      setGroupDragOffset({
        x: x - marker.x,
        y: y - marker.y
      });
      return;
    }

    // ‡∏•‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏Å‡πà‡∏≤‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà marker ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
    if (selectedMarkers.length > 0) {
      setSelectedMarkers([]);
    }

    // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‡πÉ‡∏ä‡πâ‡∏Å‡∏≤‡∏£‡∏•‡∏≤‡∏Å marker ‡πÄ‡∏î‡∏µ‡πà‡∏¢‡∏ß
    setDraggedMarker(marker);
    setIsDragging(true);
  };

  // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏´‡∏ß‡∏Ç‡∏≠‡∏á‡πÄ‡∏°‡∏≤‡∏™‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏•‡∏≤‡∏Å marker
  const handleMarkerMove = e => {
    if (!draggedMarker || !isDragging) return;

    const rect = imageRef.current.getBoundingClientRect();
    const x = Math.max(0, Math.min(e.clientX - rect.left, rect.width));
    const y = Math.max(0, Math.min(e.clientY - rect.top, rect.height));

    setMarkers(
      markers.map(marker => {
        if (marker.id === draggedMarker.id) {
          const previousX = marker.x;
          const previousY = marker.y;

          const updatedMarker = { ...marker, x, y };
          const zone = findMarkerZone(updatedMarker);
          if (zone) {
            updatedMarker.group = zone.name;
          }

          addToHistory(ACTION_TYPES.MOVE_MARKER, {
            id: marker.id,
            previousX,
            previousY,
            x,
            y
          });

          return updatedMarker;
        }
        return marker;
      })
    );
  };

  // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏à‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏•‡∏≤‡∏á
  const handleImageMouseDown = e => {
    if (isDragging || isPanning) return;

    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏Å‡∏î middle click ‡∏´‡∏£‡∏∑‡∏≠ Space+click ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö panning
    if (e.button === 1 || (e.button === 0 && e.ctrlKey)) {
      e.preventDefault();
      setIsPanning(true);
      setPanStart({ x: e.clientX - panOffset.x, y: e.clientY - panOffset.y });
      return;
    }

    // ‡πÅ‡∏õ‡∏•‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÄ‡∏°‡∏≤‡∏™‡πå‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ö‡∏ô‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà zoom ‡πÅ‡∏•‡πâ‡∏ß
    const rect = imageRef.current.getBoundingClientRect();
    const containerRect = containerRef.current.getBoundingClientRect();
    const mouseX = e.clientX - containerRect.left;
    const mouseY = e.clientY - containerRect.top;

    const x = (mouseX - panOffset.x) / zoomLevel;
    const y = (mouseY - panOffset.y) / zoomLevel;

    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏Ç‡∏≠‡∏ö‡πÄ‡∏Ç‡∏ï‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    const imageWidth = rect.width / zoomLevel;
    const imageHeight = rect.height / zoomLevel;
    if (x < 0 || x > imageWidth || y < 0 || y > imageHeight) {
      return;
    }

    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏Å‡∏î Shift ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö‡∏Å‡∏•‡∏∏‡πà‡∏°
    if (e.shiftKey) {
      // ‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á zone
      setMouseDownStart(null);
      setMouseDownTime(null);
      setHasDragged(false);
      setIsSelectingZone(false);
      setSelectionStart(null);
      setSelectionEnd(null);

      // ‡πÄ‡∏£‡∏¥‡πà‡∏° group selection
      setIsGroupSelecting(true);
      setGroupSelectionStart({ x, y });
      setGroupSelectionEnd({ x, y });
      setSelectedMarkers([]);
      setSelectedZones([]);
      return;
    }

    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà marker ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ß‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    const clickedMarker = markers.find(marker => {
      const distance = Math.sqrt(Math.pow(marker.x - x, 2) + Math.pow(marker.y - y, 2));
      return distance <= 15 && selectedMarkers.includes(marker.id);
    });

    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà zone ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ß‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    const clickedZone = zones.find(zone => {
      return isPointInZone(x, y, zone) && selectedZones.includes(zone.id);
    });

    // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏ó‡∏±‡πâ‡∏á markers ‡πÅ‡∏•‡∏∞ zones ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ß‡πâ ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏Å‡∏≤‡∏£‡∏•‡∏≤‡∏á‡πÅ‡∏ö‡∏ö‡∏ú‡∏™‡∏°
    if ((clickedMarker || clickedZone) && selectedMarkers.length > 0 && selectedZones.length > 0) {
      // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å original positions ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á markers ‡πÅ‡∏•‡∏∞ zones
      setMarkers(prevMarkers =>
        prevMarkers.map(marker => {
          if (selectedMarkers.includes(marker.id)) {
            return { ...marker, originalX: marker.x, originalY: marker.y };
          }
          return marker;
        })
      );

      setZones(prevZones =>
        prevZones.map(zone => {
          if (selectedZones.includes(zone.id)) {
            return { ...zone, originalX: zone.x, originalY: zone.y };
          }
          return zone;
        })
      );

      setIsDraggingMixed(true);

      // ‡πÄ‡∏Å‡πá‡∏ö reference point ‡πÅ‡∏•‡∏∞ offset
      const referencePoint = clickedMarker
        ? { x: clickedMarker.x, y: clickedMarker.y, type: "marker", id: clickedMarker.id }
        : { x: clickedZone.x, y: clickedZone.y, type: "zone", id: clickedZone.id };

      setDragReference(referencePoint);
      setGroupDragOffset({
        x: x - referencePoint.x,
        y: y - referencePoint.y
      });
      return;
    }

    // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏â‡∏û‡∏≤‡∏∞ markers
    if (clickedMarker && selectedMarkers.length > 0 && selectedZones.length === 0) {
      // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å original positions ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏•‡∏≤‡∏Å
      setMarkers(prevMarkers =>
        prevMarkers.map(marker => {
          if (selectedMarkers.includes(marker.id)) {
            return { ...marker, originalX: marker.x, originalY: marker.y };
          }
          return marker;
        })
      );

      setIsDraggingGroup(true);
      setGroupDragOffset({
        x: x - clickedMarker.x,
        y: y - clickedMarker.y
      });
      return;
    }

    // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏â‡∏û‡∏≤‡∏∞ zones
    if (clickedZone && selectedZones.length > 0 && selectedMarkers.length === 0) {
      // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å original positions ‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏•‡∏≤‡∏Å zones
      setZones(prevZones =>
        prevZones.map(zone => {
          if (selectedZones.includes(zone.id)) {
            return { ...zone, originalX: zone.x, originalY: zone.y };
          }
          return zone;
        })
      );

      setIsDraggingZoneGroup(true);
      setGroupDragOffset({
        x: x - clickedZone.x,
        y: y - clickedZone.y
      });
      return;
    }

    // ‡∏•‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ß‡πà‡∏≤‡∏á
    if (selectedMarkers.length > 0 || selectedZones.length > 0) {
      setSelectedMarkers([]);
      setSelectedZones([]);
    }

    // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ mouseDownStart ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ó‡∏≥ group selection
    setMouseDownStart({ x, y });
    setMouseDownTime(Date.now());
    setHasDragged(false);
  };

  // ‡∏´‡∏≤‡∏™‡∏µ‡∏Ç‡∏≠‡∏á marker
  const getMarkerColors = color => {
    const colorMap = {
      red: { bg: "bg-red-500", hover: "hover:bg-red-600" },
      yellow: { bg: "bg-yellow-500", hover: "hover:bg-yellow-600" },
      green: { bg: "bg-green-500", hover: "hover:bg-green-600" },
      blue: { bg: "bg-blue-500", hover: "hover:bg-blue-600" },
      pink: { bg: "bg-pink-500", hover: "hover:bg-pink-600" },
      indigo: { bg: "bg-indigo-500", hover: "hover:bg-indigo-600" },
      teal: { bg: "bg-teal-500", hover: "hover:bg-teal-600" }
    };
    return colorMap[color] || colorMap.red;
  };

  // ‡πÅ‡∏õ‡∏•‡∏á‡∏™‡∏µ Tailwind ‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏µ RGB
  const colorMap = {
    red: "#EF4444", // bg-red-500
    yellow: "#F59E0B", // bg-yellow-500
    green: "#10B981", // bg-green-500
    blue: "#3B82F6", // bg-blue-500
    pink: "#EC4899", // bg-pink-500
    indigo: "#6366F1", // bg-indigo-500
    teal: "#14B8A6" // bg-teal-500
  };

  // ‡∏´‡∏≤‡∏™‡∏µ‡∏Ç‡∏≠‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏°
  const getZoneColors = color => {
    const colorMap = {
      blue: { bg: "bg-blue-500", border: "border-blue-500", bgOpacity: "bg-blue-200" },
      purple: { bg: "bg-purple-500", border: "border-purple-500", bgOpacity: "bg-purple-200" },
      orange: { bg: "bg-orange-500", border: "border-orange-500", bgOpacity: "bg-orange-200" },
      emerald: { bg: "bg-emerald-500", border: "border-emerald-500", bgOpacity: "bg-emerald-200" },
      rose: { bg: "bg-rose-500", border: "border-rose-500", bgOpacity: "bg-rose-200" },
      cyan: { bg: "bg-cyan-500", border: "border-cyan-500", bgOpacity: "bg-cyan-200" },
      amber: { bg: "bg-amber-500", border: "border-amber-500", bgOpacity: "bg-amber-200" }
    };
    return colorMap[color] || colorMap.blue;
  };

  // ‡∏™‡∏•‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á/‡∏ã‡πà‡∏≠‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°
  const toggleZoneVisibility = zoneId => {
    setVisibleZones({
      ...visibleZones,
      [zoneId]: !visibleZones[zoneId]
    });
  };

  // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç marker
  const handleEditMarkerSubmit = e => {
    e.preventDefault();
    if (editMarkerData && originalMarkerData) {
      // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç marker
      addToHistory(ACTION_TYPES.EDIT_MARKER, {
        id: editMarkerData.id,
        previous: originalMarkerData,
        current: editMarkerData
      });

      setMarkers(prevMarkers =>
        prevMarkers.map(marker => {
          if (marker.id === editMarkerData.id) {
            if (marker.group !== editMarkerData.group) {
              const newZone = zones.find(zone => zone.name === editMarkerData.group);
              if (newZone) {
                const center = getZoneCenter(newZone);
                return {
                  ...marker,
                  ...editMarkerData,
                  x: center.x,
                  y: center.y,
                  originalX: center.x,
                  originalY: center.y
                };
              }
            }
            return { ...marker, ...editMarkerData };
          }
          return marker;
        })
      );

      setMarkerSizes(prev => ({
        ...prev,
        [editMarkerData.id]: editMarkerData.size
      }));

      setShowEditMarkerModal(false);
      setEditMarkerData(null);
      setOriginalMarkerData(null);
    }
  };

  // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏•‡∏≤‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏°
  const handleZoneMouseDown = (e, zone, handle = null) => {
    e.preventDefault();
    e.stopPropagation();

    // ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏≤‡∏Å‡∏ñ‡πâ‡∏≤‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥ group selection
    if (isGroupSelecting) {
      return;
    }

    const rect = imageRef.current.getBoundingClientRect();
    const mouseX = e.clientX - rect.left;
    const mouseY = e.clientY - rect.top;

    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ zone ‡∏ô‡∏µ‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà ‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡∏°‡∏µ handle
    if (selectedZones.includes(zone.id) && selectedZones.length > 0 && !handle) {
      // ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏ó‡∏±‡πâ‡∏á markers ‡πÅ‡∏•‡∏∞ zones ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ß‡πâ ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏Å‡∏≤‡∏£‡∏•‡∏≤‡∏Å‡πÅ‡∏ö‡∏ö‡∏ú‡∏™‡∏°
      if (selectedMarkers.length > 0) {
        // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å original positions ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á markers ‡πÅ‡∏•‡∏∞ zones
        setMarkers(prevMarkers =>
          prevMarkers.map(marker => {
            if (selectedMarkers.includes(marker.id)) {
              return { ...marker, originalX: marker.x, originalY: marker.y };
            }
            return marker;
          })
        );

        setZones(prevZones =>
          prevZones.map(z => {
            if (selectedZones.includes(z.id)) {
              return { ...z, originalX: z.x, originalY: z.y };
            }
            return z;
          })
        );

        setIsDraggingMixed(true);

        // ‡πÄ‡∏Å‡πá‡∏ö reference point ‡πÅ‡∏•‡∏∞ offset
        const referencePoint = { x: zone.x, y: zone.y, type: "zone", id: zone.id };
        setDragReference(referencePoint);
        setGroupDragOffset({
          x: mouseX - zone.x,
          y: mouseY - zone.y
        });
        return;
      }

      // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏â‡∏û‡∏≤‡∏∞ zones
      setZones(prevZones =>
        prevZones.map(z => {
          if (selectedZones.includes(z.id)) {
            return { ...z, originalX: z.x, originalY: z.y };
          }
          return z;
        })
      );

      setIsDraggingZoneGroup(true);
      setGroupDragOffset({
        x: mouseX - zone.x,
        y: mouseY - zone.y
      });
      return;
    }

    // ‡∏•‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏Å‡πà‡∏≤‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà zone ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
    if (selectedZones.length > 0 && !selectedZones.includes(zone.id)) {
      setSelectedZones([]);
      setSelectedMarkers([]);
    }

    if (handle === "rotate") {
      setIsRotatingZone(true);
      const center = {
        x: zone.x + zone.width / 2,
        y: zone.y + zone.height / 2
      };
      setRotationStartAngle(calculateAngle(center, { x: mouseX, y: mouseY }) - (zone.rotation || 0));
    } else {
      setOriginalZoneState({
        offsetX: mouseX - zone.x,
        offsetY: mouseY - zone.y,
        initialX: zone.x,
        initialY: zone.y,
        initialWidth: zone.width,
        initialHeight: zone.height,
        rotation: zone.rotation || 0
      });

      if (handle) {
        setIsResizingZone(true);
        setResizeHandle(handle);
      } else {
        setIsDraggingZone(true);
      }
    }
    setDraggedZone(zone);
  };

  // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ mouse move
  const handleMouseMove = e => {
    // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ panning
    if (isPanning) {
      setPanOffset({
        x: e.clientX - panStart.x,
        y: e.clientY - panStart.y
      });
      return;
    }

    if (isDragging) {
      handleMarkerMove(e);
      return;
    }

    // ‡πÅ‡∏õ‡∏•‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÄ‡∏°‡∏≤‡∏™‡πå‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ö‡∏ô‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà zoom ‡πÅ‡∏•‡πâ‡∏ß
    const rect = imageRef.current.getBoundingClientRect();
    const containerRect = containerRef.current.getBoundingClientRect();
    const rawMouseX = e.clientX - containerRect.left;
    const rawMouseY = e.clientY - containerRect.top;

    const mouseX = Math.max(0, Math.min((rawMouseX - panOffset.x) / zoomLevel, rect.width / zoomLevel));
    const mouseY = Math.max(0, Math.min((rawMouseY - panOffset.y) / zoomLevel, rect.height / zoomLevel));

    if (isRotatingZone && draggedZone) {
      const center = {
        x: draggedZone.x + draggedZone.width / 2,
        y: draggedZone.y + draggedZone.height / 2
      };
      const currentAngle = calculateAngle(center, { x: mouseX, y: mouseY }) - rotationStartAngle;

      setZones(prevZones => prevZones.map(zone => (zone.id === draggedZone.id ? { ...zone, rotation: currentAngle } : zone)));
      return;
    }

    if (isDraggingZone && draggedZone && originalZoneState) {
      const rect = imageRef.current.getBoundingClientRect();
      const mouseX = Math.max(0, Math.min(e.clientX - rect.left, rect.width));
      const mouseY = Math.max(0, Math.min(e.clientY - rect.top, rect.height));

      setZones(prevZones =>
        prevZones.map(zone =>
          zone.id === draggedZone.id
            ? {
                ...zone,
                x: mouseX - originalZoneState.offsetX,
                y: mouseY - originalZoneState.offsetY
              }
            : zone
        )
      );
      return;
    }

    if (isResizingZone && draggedZone && originalZoneState) {
      setZones(prevZones =>
        prevZones.map(zone => {
          if (zone.id === draggedZone.id) {
            let newZone = { ...zone };
            const minSize = 50;

            // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ç‡∏≠‡∏ö‡πÄ‡∏Ç‡∏ï‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î‡πÅ‡∏•‡∏∞‡∏ï‡πà‡∏≥‡∏™‡∏∏‡∏î
            const originalLeft = originalZoneState.initialX;
            const originalTop = originalZoneState.initialY;
            const originalRight = originalLeft + originalZoneState.initialWidth;
            const originalBottom = originalTop + originalZoneState.initialHeight;

            // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Å‡∏≤‡∏£‡∏¢‡πà‡∏≠‡∏Ç‡∏¢‡∏≤‡∏¢‡πÅ‡∏•‡∏∞‡∏Å‡∏•‡∏±‡∏ö‡∏î‡πâ‡∏≤‡∏ô
            const calculateReversibleDimension = (mousePos, fixedPos, isStart) => {
              const distance = mousePos - fixedPos;
              const isReversed = isStart ? distance < 0 : distance < minSize;

              if (isReversed) {
                // ‡∏Å‡∏•‡∏±‡∏ö‡∏î‡πâ‡∏≤‡∏ô
                return {
                  start: isStart ? fixedPos + distance : fixedPos,
                  size: Math.abs(distance)
                };
              } else {
                // ‡∏õ‡∏Å‡∏ï‡∏¥
                return {
                  start: isStart ? mousePos : fixedPos,
                  size: Math.abs(distance)
                };
              }
            };

            switch (resizeHandle) {
              case "n": {
                const result = calculateReversibleDimension(mouseY, originalBottom, true);
                newZone.y = result.start;
                newZone.height = result.size;
                break;
              }
              case "s": {
                const result = calculateReversibleDimension(mouseY, originalTop, false);
                newZone.y = result.start;
                newZone.height = result.size;
                break;
              }
              case "e": {
                const result = calculateReversibleDimension(mouseX, originalLeft, false);
                newZone.x = result.start;
                newZone.width = result.size;
                break;
              }
              case "w": {
                const result = calculateReversibleDimension(mouseX, originalRight, true);
                newZone.x = result.start;
                newZone.width = result.size;
                break;
              }
              case "ne": {
                const vertical = calculateReversibleDimension(mouseY, originalBottom, true);
                const horizontal = calculateReversibleDimension(mouseX, originalLeft, false);
                newZone.y = vertical.start;
                newZone.height = vertical.size;
                newZone.x = horizontal.start;
                newZone.width = horizontal.size;
                break;
              }
              case "nw": {
                const vertical = calculateReversibleDimension(mouseY, originalBottom, true);
                const horizontal = calculateReversibleDimension(mouseX, originalRight, true);
                newZone.y = vertical.start;
                newZone.height = vertical.size;
                newZone.x = horizontal.start;
                newZone.width = horizontal.size;
                break;
              }
              case "se": {
                const vertical = calculateReversibleDimension(mouseY, originalTop, false);
                const horizontal = calculateReversibleDimension(mouseX, originalLeft, false);
                newZone.y = vertical.start;
                newZone.height = vertical.size;
                newZone.x = horizontal.start;
                newZone.width = horizontal.size;
                break;
              }
              case "sw": {
                const vertical = calculateReversibleDimension(mouseY, originalTop, false);
                const horizontal = calculateReversibleDimension(mouseX, originalRight, true);
                newZone.y = vertical.start;
                newZone.height = vertical.size;
                newZone.x = horizontal.start;
                newZone.width = horizontal.size;
                break;
              }
            }

            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥
            if (newZone.width < minSize || newZone.height < minSize) {
              return zone;
            }

            return newZone;
          }
          return zone;
        })
      );
      return;
    }

    // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÉ‡∏´‡∏°‡πà (‡∏™‡∏£‡πâ‡∏≤‡∏á zone) - ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏ó‡∏≥‡∏ñ‡πâ‡∏≤‡∏Å‡∏≥‡∏•‡∏±‡∏á group selecting
    if (mouseDownStart && !isGroupSelecting) {
      // ‡πÅ‡∏õ‡∏•‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÄ‡∏°‡∏≤‡∏™‡πå‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ö‡∏ô‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà zoom ‡πÅ‡∏•‡πâ‡∏ß
      const rect = imageRef.current.getBoundingClientRect();
      const containerRect = containerRef.current.getBoundingClientRect();
      const rawCurrentX = e.clientX - containerRect.left;
      const rawCurrentY = e.clientY - containerRect.top;

      const currentX = (rawCurrentX - panOffset.x) / zoomLevel;
      const currentY = (rawCurrentY - panOffset.y) / zoomLevel;

      const distance = getDistance(mouseDownStart, { x: currentX, y: currentY });

      if (distance >= DRAG_THRESHOLD && !isSelectingZone && !isGroupSelecting) {
        setIsSelectingZone(true);
        setSelectionStart(mouseDownStart);
        setHasDragged(true);
      }

      if (isSelectingZone) {
        const imageWidth = rect.width / zoomLevel;
        const imageHeight = rect.height / zoomLevel;
        const x = Math.max(0, Math.min(currentX, imageWidth));
        const y = Math.max(0, Math.min(currentY, imageHeight));
        setSelectionEnd({ x, y });
      }
    }

    // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö‡∏Å‡∏•‡∏∏‡πà‡∏°
    if (isGroupSelecting && groupSelectionStart) {
      setGroupSelectionEnd({ x: mouseX, y: mouseY });

      // ‡∏´‡∏≤ markers ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
      const markersInSelection = markers
        .filter(marker => isMarkerInSelection(marker, groupSelectionStart, { x: mouseX, y: mouseY }))
        .map(marker => marker.id);

      // ‡∏´‡∏≤ zones ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
      const zonesInSelection = zones
        .filter(zone => isZoneInSelection(zone, groupSelectionStart, { x: mouseX, y: mouseY }))
        .map(zone => zone.id);

      setSelectedMarkers(markersInSelection);
      setSelectedZones(zonesInSelection);
      return;
    }

    // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏•‡∏≤‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏°
    if (isDraggingGroup && selectedMarkers.length > 0) {
      // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÉ‡∏´‡∏°‡πà‡∏à‡∏≤‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á mouse ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
      const newX = mouseX - groupDragOffset.x;
      const newY = mouseY - groupDragOffset.y;

      // ‡∏´‡∏≤ marker ‡∏´‡∏•‡∏±‡∏Å‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏à‡∏∏‡∏î‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á (marker ‡∏ï‡∏±‡∏ß‡πÅ‡∏£‡∏Å‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å)
      const referenceMarker = markers.find(m => selectedMarkers.includes(m.id));
      if (referenceMarker) {
        // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏à‡∏≤‡∏Å reference marker
        const offsetX = newX - referenceMarker.x;
        const offsetY = newY - referenceMarker.y;

        setMarkers(prevMarkers =>
          prevMarkers.map(marker => {
            if (selectedMarkers.includes(marker.id)) {
              const newMarkerX = Math.max(0, Math.min(marker.x + offsetX, rect.width));
              const newMarkerY = Math.max(0, Math.min(marker.y + offsetY, rect.height));
              return { ...marker, x: newMarkerX, y: newMarkerY };
            }
            return marker;
          })
        );
      }
      return;
    }

    // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏•‡∏≤‡∏Å‡πÅ‡∏ö‡∏ö‡∏ú‡∏™‡∏° (markers ‡πÅ‡∏•‡∏∞ zones ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô)
    if (isDraggingMixed && dragReference && (selectedMarkers.length > 0 || selectedZones.length > 0)) {
      // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÉ‡∏´‡∏°‡πà‡∏Ç‡∏≠‡∏á‡∏à‡∏∏‡∏î‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏à‡∏≤‡∏Å mouse position
      const newReferenceX = mouseX - groupDragOffset.x;
      const newReferenceY = mouseY - groupDragOffset.y;

      // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì offset ‡∏à‡∏≤‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏à‡∏∏‡∏î‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á
      const offsetX = newReferenceX - dragReference.x;
      const offsetY = newReferenceY - dragReference.y;

      // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó markers
      if (selectedMarkers.length > 0) {
        setMarkers(prevMarkers =>
          prevMarkers.map(marker => {
            if (selectedMarkers.includes(marker.id)) {
              const originalX = marker.originalX || marker.x;
              const originalY = marker.originalY || marker.y;
              const newMarkerX = Math.max(0, Math.min(originalX + offsetX, rect.width));
              const newMarkerY = Math.max(0, Math.min(originalY + offsetY, rect.height));
              return { ...marker, x: newMarkerX, y: newMarkerY };
            }
            return marker;
          })
        );
      }

      // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó zones
      if (selectedZones.length > 0) {
        setZones(prevZones =>
          prevZones.map(zone => {
            if (selectedZones.includes(zone.id)) {
              const originalX = zone.originalX || zone.x;
              const originalY = zone.originalY || zone.y;
              const newZoneX = Math.max(0, Math.min(originalX + offsetX, rect.width - zone.width));
              const newZoneY = Math.max(0, Math.min(originalY + offsetY, rect.height - zone.height));
              return { ...zone, x: newZoneX, y: newZoneY };
            }
            return zone;
          })
        );
      }
      return;
    }

    // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏•‡∏≤‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏° zones
    if (isDraggingZoneGroup && selectedZones.length > 0) {
      // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÉ‡∏´‡∏°‡πà‡∏à‡∏≤‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á mouse ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
      const newX = mouseX - groupDragOffset.x;
      const newY = mouseY - groupDragOffset.y;

      // ‡∏´‡∏≤ zone ‡∏´‡∏•‡∏±‡∏Å‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏à‡∏∏‡∏î‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á (zone ‡∏ï‡∏±‡∏ß‡πÅ‡∏£‡∏Å‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡πÄ‡∏•‡∏∑‡∏≠‡∏Å)
      const referenceZone = zones.find(z => selectedZones.includes(z.id));
      if (referenceZone) {
        // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏à‡∏≤‡∏Å reference zone
        const offsetX = newX - referenceZone.x;
        const offsetY = newY - referenceZone.y;

        setZones(prevZones =>
          prevZones.map(zone => {
            if (selectedZones.includes(zone.id)) {
              const newZoneX = Math.max(0, Math.min(zone.x + offsetX, rect.width - zone.width));
              const newZoneY = Math.max(0, Math.min(zone.y + offsetY, rect.height - zone.height));
              return { ...zone, x: newZoneX, y: newZoneY };
            }
            return zone;
          })
        );
      }
      return;
    }

    if (isRotatingZone && draggedZone) {
      const center = {
        x: draggedZone.x + draggedZone.width / 2,
        y: draggedZone.y + draggedZone.height / 2
      };
      const currentAngle = calculateAngle(center, { x: mouseX, y: mouseY }) - rotationStartAngle;

      setZones(prevZones => prevZones.map(zone => (zone.id === draggedZone.id ? { ...zone, rotation: currentAngle } : zone)));
      return;
    }
  };

  // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏Å‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ mouse up
  const handleMouseUp = () => {
    // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ panning
    if (isPanning) {
      setIsPanning(false);
      return;
    }

    // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö‡∏Å‡∏•‡∏∏‡πà‡∏°
    if (isGroupSelecting) {
      setIsGroupSelecting(false);
      setGroupSelectionStart(null);
      setGroupSelectionEnd(null);
      // ‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Ç‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á zone ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á modal
      setIsSelectingZone(false);
      setSelectionStart(null);
      setSelectionEnd(null);
      setHasDragged(false);
      // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏¥‡∏î popup ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å group selection
      setJustFinishedGroupSelection(true);
      setTimeout(() => setJustFinishedGroupSelection(false), 100);
      return;
    }

    // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏•‡∏≤‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏°
    if (isDraggingGroup && selectedMarkers.length > 0) {
      // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏¢‡πâ‡∏≤‡∏¢‡∏Å‡∏•‡∏∏‡πà‡∏°
      const movedMarkers = markers.filter(m => selectedMarkers.includes(m.id));
      const originalPositions = movedMarkers.map(m => ({
        id: m.id,
        originalX: m.originalX,
        originalY: m.originalY,
        currentX: m.x,
        currentY: m.y
      }));

      // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏¢‡πâ‡∏≤‡∏¢‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á
      const hasPositionChanged = originalPositions.some(p => p.originalX !== p.currentX || p.originalY !== p.currentY);

      if (hasPositionChanged) {
        addToHistory(ACTION_TYPES.MOVE_GROUP, {
          markers: originalPositions
        });

        // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏Ç‡∏≠‡∏á markers ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏•‡∏≤‡∏Å
        setMarkers(prevMarkers =>
          prevMarkers.map(marker => {
            if (selectedMarkers.includes(marker.id)) {
              const newZone = zones.find(zone => isPointInZone(marker.x, marker.y, zone));
              return {
                ...marker,
                group: newZone ? newZone.name : "Marker"
              };
            }
            return marker;
          })
        );
      }

      setIsDraggingGroup(false);
      setGroupDragOffset({ x: 0, y: 0 });
      setDragReference(null);
      return;
    }

    // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏•‡∏≤‡∏Å‡πÅ‡∏ö‡∏ö‡∏ú‡∏™‡∏°
    if (isDraggingMixed && (selectedMarkers.length > 0 || selectedZones.length > 0)) {
      let hasPositionChanged = false;
      const historyData = {};

      // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ markers
      if (selectedMarkers.length > 0) {
        const movedMarkers = markers.filter(m => selectedMarkers.includes(m.id));
        const markerPositions = movedMarkers.map(m => ({
          id: m.id,
          originalX: m.originalX,
          originalY: m.originalY,
          currentX: m.x,
          currentY: m.y
        }));

        const markerChanged = markerPositions.some(p => p.originalX !== p.currentX || p.originalY !== p.currentY);

        if (markerChanged) {
          hasPositionChanged = true;
          historyData.markers = markerPositions;

          // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏Ç‡∏≠‡∏á markers ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏•‡∏≤‡∏Å
          setMarkers(prevMarkers =>
            prevMarkers.map(marker => {
              if (selectedMarkers.includes(marker.id)) {
                const newZone = zones.find(zone => isPointInZone(marker.x, marker.y, zone));
                return {
                  ...marker,
                  group: newZone ? newZone.name : "Marker"
                };
              }
              return marker;
            })
          );
        }
      }

      // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ zones
      if (selectedZones.length > 0) {
        const movedZones = zones.filter(z => selectedZones.includes(z.id));
        const zonePositions = movedZones.map(z => ({
          id: z.id,
          originalX: z.originalX,
          originalY: z.originalY,
          currentX: z.x,
          currentY: z.y
        }));

        const zoneChanged = zonePositions.some(p => p.originalX !== p.currentX || p.originalY !== p.currentY);

        if (zoneChanged) {
          hasPositionChanged = true;
          historyData.zones = zonePositions;
        }
      }

      // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á
      if (hasPositionChanged) {
        addToHistory(ACTION_TYPES.MOVE_MIXED_GROUP, historyData);
      }

      setIsDraggingMixed(false);
      setGroupDragOffset({ x: 0, y: 0 });
      setDragReference(null);
      return;
    }

    // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏•‡∏≤‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏° zones
    if (isDraggingZoneGroup && selectedZones.length > 0) {
      // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏¢‡πâ‡∏≤‡∏¢‡∏Å‡∏•‡∏∏‡πà‡∏° zones
      const movedZones = zones.filter(z => selectedZones.includes(z.id));
      const originalPositions = movedZones.map(z => ({
        id: z.id,
        originalX: z.originalX,
        originalY: z.originalY,
        currentX: z.x,
        currentY: z.y
      }));

      // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏¢‡πâ‡∏≤‡∏¢‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á
      const hasPositionChanged = originalPositions.some(p => p.originalX !== p.currentX || p.originalY !== p.currentY);

      if (hasPositionChanged) {
        addToHistory(ACTION_TYPES.MOVE_ZONE_GROUP, {
          zones: originalPositions
        });
      }

      setIsDraggingZoneGroup(false);
      setGroupDragOffset({ x: 0, y: 0 });
      setDragReference(null);
      return;
    }

    if (isDraggingZone || isResizingZone || isRotatingZone) {
      // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏Ç‡∏≠‡∏á zone
      if (draggedZone && originalZoneState) {
        const currentZone = zones.find(z => z.id === draggedZone.id);
        if (currentZone) {
          addToHistory(ACTION_TYPES.EDIT_ZONE, {
            id: draggedZone.id,
            previous: {
              x: originalZoneState.initialX,
              y: originalZoneState.initialY,
              width: originalZoneState.initialWidth,
              height: originalZoneState.initialHeight,
              rotation: originalZoneState.rotation
            },
            current: {
              x: currentZone.x,
              y: currentZone.y,
              width: currentZone.width,
              height: currentZone.height,
              rotation: currentZone.rotation
            }
          });
        }
      }
      setIsDraggingZone(false);
      setIsResizingZone(false);
      setIsRotatingZone(false);
      setDraggedZone(null);
      setResizeHandle(null);
      setOriginalZoneState(null);
      setRotationStartAngle(0);
    }

    if (isDragging) {
      const draggedMarkerData = markers.find(m => m.id === draggedMarker.id);
      if (draggedMarkerData) {
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ marker ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≠‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÉ‡∏î‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
        const newZone = zones.find(zone => isPointInZone(draggedMarkerData.x, draggedMarkerData.y, zone));

        // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏Ç‡∏≠‡∏á marker
        setMarkers(prevMarkers =>
          prevMarkers.map(marker =>
            marker.id === draggedMarker.id ? { ...marker, group: newZone ? newZone.name : "Marker" } : marker
          )
        );
      }
      setDraggedMarker(null);
      setIsDragging(false);
    }

    if (isSelectingZone && selectionStart && selectionEnd && hasDragged && !isGroupSelecting) {
      const distance = getDistance(selectionStart, selectionEnd);

      if (distance >= DRAG_THRESHOLD) {
        setCurrentSelection({
          startX: selectionStart.x,
          startY: selectionStart.y,
          endX: selectionEnd.x,
          endY: selectionEnd.y
        });
        setShowZoneModal(true);
      }

      setIsSelectingZone(false);
      setSelectionStart(null);
      setSelectionEnd(null);
    }

    // ‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤‡∏ï‡πà‡∏≤‡∏á‡πÜ
    setMouseDownStart(null);
    setMouseDownTime(null);

    setTimeout(() => {
      setHasDragged(false);
    }, 100);
  };

  // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏•‡∏≤‡∏Å marker ‡πÉ‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
  const handleMarkerDragStart = (e, marker) => {
    e.stopPropagation();
    setDraggedListMarker(marker);
  };

  const handleMarkerDragEnd = () => {
    setDraggedListMarker(null);
    setDragOverZoneId(null);
  };

  const handleZoneDragOver = (e, zone) => {
    e.preventDefault();
    setDragOverZoneId(zone.id);
  };

  const handleZoneDragLeave = () => {
    setDragOverZoneId(null);
  };

  const handleZoneDrop = (e, targetZone) => {
    e.preventDefault();
    if (draggedListMarker && targetZone.name !== draggedListMarker.group) {
      // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡∏∏‡∏î‡∏Å‡∏∂‡πà‡∏á‡∏Å‡∏•‡∏≤‡∏á‡∏Ç‡∏≠‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢
      const center = getZoneCenter(targetZone);

      // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó marker
      setMarkers(prevMarkers =>
        prevMarkers.map(marker =>
          marker.id === draggedListMarker.id
            ? {
                ...marker,
                group: targetZone.name,
                x: center.x,
                y: center.y,
                originalX: center.x,
                originalY: center.y
              }
            : marker
        )
      );
    }
    setDraggedListMarker(null);
    setDragOverZoneId(null);
  };

  // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î marker
  const handleMarkerSizeChange = (markerId, newSize) => {
    setMarkerSizes(prev => ({
      ...prev,
      [markerId]: Math.max(MIN_MARKER_SIZE, Math.min(MAX_MARKER_SIZE, newSize))
    }));
  };

  // ‡πÄ‡∏û‡∏¥‡πà‡∏° Component ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ß‡∏≤‡∏î‡∏£‡∏π‡∏õ‡∏ó‡∏£‡∏á‡∏î‡πâ‡∏ß‡∏¢ Canvas
  const MarkerShape = ({ shape, color, size, className = "" }) => {
    const canvasRef = useRef(null);

    useEffect(
      () => {
        const canvas = canvasRef.current;
        const ctx = canvas.getContext("2d");
        const scale = window.devicePixelRatio || 1;

        // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ç‡∏ô‡∏≤‡∏î canvas ‡∏ï‡∏≤‡∏° scale ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏°‡∏ä‡∏±‡∏î
        canvas.width = size * scale;
        canvas.height = size * scale;
        ctx.scale(scale, scale);

        // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏™‡πÑ‡∏ï‡∏•‡πå‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô
        ctx.fillStyle = color;
        ctx.strokeStyle = "#ffffff";
        ctx.lineWidth = 2;

        // ‡∏•‡πâ‡∏≤‡∏á canvas
        ctx.clearRect(0, 0, size, size);

        // ‡∏ß‡∏≤‡∏î‡∏£‡∏π‡∏õ‡∏ó‡∏£‡∏á‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î
        const centerX = size / 2;
        const centerY = size / 2;
        const radius = (size - 4) / 2; // ‡∏•‡∏î‡∏Ç‡∏ô‡∏≤‡∏î‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏°‡∏µ‡∏Ç‡∏≠‡∏ö

        switch (shape) {
          case "circle":
            ctx.beginPath();
            ctx.arc(centerX, centerY, radius, 0, Math.PI * 2);
            ctx.fill();
            ctx.stroke();
            break;

          case "square":
            ctx.beginPath();
            ctx.rect(2, 2, size - 4, size - 4);
            ctx.fill();
            ctx.stroke();
            break;

          case "triangle":
            ctx.beginPath();
            ctx.moveTo(centerX, 2);
            ctx.lineTo(size - 2, size - 2);
            ctx.lineTo(2, size - 2);
            ctx.closePath();
            ctx.fill();
            ctx.stroke();
            break;

          case "star":
            ctx.beginPath();
            const outerRadius = radius;
            const innerRadius = radius * 0.4;

            for (let i = 0; i < 10; i++) {
              const r = i % 2 === 0 ? outerRadius : innerRadius;
              const angle = (i * Math.PI) / 5 - Math.PI / 2;
              const x = centerX + r * Math.cos(angle);
              const y = centerY + r * Math.sin(angle);

              if (i === 0) {
                ctx.moveTo(x, y);
              } else {
                ctx.lineTo(x, y);
              }
            }

            ctx.closePath();
            ctx.fill();
            ctx.stroke();
            break;
        }

        // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏á‡∏≤
        ctx.shadowColor = "rgba(0, 0, 0, 0.3)";
        ctx.shadowBlur = 4;
        ctx.shadowOffsetX = 2;
        ctx.shadowOffsetY = 2;
      },
      [shape, color, size]
    );

    return (
      <canvas
        ref={canvasRef}
        width={size}
        height={size}
        className={`${className} transition-transform duration-200`}
        style={{
          width: size,
          height: size
        }}
      />
    );
  };

  // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô renderMarker
  const renderMarker = (marker, isOnMap = true) => {
    const isEditing = editMarkerData?.id === marker.id;
    const displayMarker = isEditing ? editMarkerData : marker;
    const markerColors = getMarkerColors(displayMarker.color);
    const size = isEditing ? displayMarker.size : markerSizes[displayMarker.id] || DEFAULT_MARKER_SIZE;
    const sizeInPixels = size * (isOnMap ? 4 : 3) * (isOnMap ? zoomLevel : 1);
    const markerColor = colorMap[displayMarker.color] || colorMap.red;
    const isSelected = selectedMarkers.includes(displayMarker.id);

    if (isOnMap) {
      return (
        <div
          className={`absolute transform -translate-x-1/2 -translate-y-1/2 group ${
            isSelected && selectedMarkers.length > 1 ? "cursor-move" : "cursor-pointer"
          }`}
          style={{
            left: displayMarker.x * zoomLevel + panOffset.x,
            top: displayMarker.y * zoomLevel + panOffset.y,
            zIndex: draggedMarker?.id === displayMarker.id || isDraggingGroup ? 1000 : 10
          }}
          onDoubleClick={e => handleMarkerDoubleClick(e, marker)}
          onMouseDown={e => handleMarkerMouseDown(e, marker)}
        >
          <div className={`relative ${draggedMarker?.id === displayMarker.id ? "scale-110" : ""}`}>
            <div
              className={`rounded-full transition-all duration-200 ${isSelected ? "ring-4 ring-blue-400 ring-opacity-75" : ""}`}
              style={{
                width: `${sizeInPixels}px`,
                height: `${sizeInPixels}px`,
                backgroundColor: markerColor
              }}
            />
            {isSelected && (
              <div
                className="absolute inset-0 border-2 border-blue-500 border-dashed rounded-full animate-pulse"
                style={{
                  width: `${sizeInPixels + 8}px`,
                  height: `${sizeInPixels + 8}px`,
                  left: "-4px",
                  top: "-4px"
                }}
              />
            )}
          </div>
          {/* Tooltip */}
          <div className="absolute bottom-8 left-1/2 transform -translate-x-1/2 bg-black bg-opacity-75 text-white text-xs rounded px-2 py-1 opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap z-20">
            <div className="font-semibold">{displayMarker.name}</div>
            <div className="text-gray-300">‡∏Å‡∏•‡∏∏‡πà‡∏°: {displayMarker.group}</div>
            <div className="text-gray-300">‡∏™‡∏µ: {colorOptions.find(c => c.value === displayMarker.color)?.label}</div>
            <div className="flex space-x-1 mt-1">
              <button
                onClick={e => {
                  e.stopPropagation();
                  resetMarkerPosition(displayMarker.id);
                }}
                className="text-blue-300 hover:text-blue-100 text-xs"
                title="‡∏Å‡∏•‡∏±‡∏ö‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÄ‡∏î‡∏¥‡∏°"
              >
                ‚Ü∫
              </button>
              <button
                onClick={e => {
                  e.stopPropagation();
                  removeMarker(displayMarker.id);
                }}
                className="text-red-300 hover:text-red-100"
              >
                ‚úï
              </button>
            </div>
          </div>
        </div>
      );
    } else {
      return (
        <div
          className={`rounded-full transition-all duration-200`}
          style={{
            width: `${sizeInPixels}px`,
            height: `${sizeInPixels}px`,
            backgroundColor: markerColor
          }}
        />
      );
    }
  };

  // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏°‡∏∏‡∏°
  const calculateAngle = (center, point) => {
    return Math.atan2(point.y - center.y, point.x - center.x) * (180 / Math.PI);
  };

  // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó JSX ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏°
  const renderZone = zone => {
    if (!visibleZones[zone.id]) return null;
    // ‡∏ñ‡πâ‡∏≤‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ô‡∏µ‡πâ ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å editZoneData ‡πÅ‡∏ó‡∏ô
    const displayZone = editZoneData?.id === zone.id ? editZoneData : zone;
    const zoneColors = getZoneColors(displayZone.color);
    const isBeingDragged = draggedZone?.id === zone.id;
    const isSelected = selectedZones.includes(zone.id);

    // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏£‡∏π‡∏õ‡∏ó‡∏£‡∏á CSS ‡∏ï‡∏≤‡∏° shape
    const getShapeStyles = shape => {
      const colorMapping = {
        blue: "rgba(59, 130, 246, 0.3)",
        purple: "rgba(147, 51, 234, 0.3)",
        orange: "rgba(249, 115, 22, 0.3)",
        emerald: "rgba(16, 185, 129, 0.3)",
        rose: "rgba(244, 63, 94, 0.3)",
        cyan: "rgba(6, 182, 212, 0.3)",
        amber: "rgba(245, 158, 11, 0.3)"
      };

      // ‡∏™‡∏µ‡∏Ç‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏™‡∏µ‡∏Ç‡∏≠‡∏á zone
      const borderColorMapping = {
        blue: "#3B82F6",
        purple: "#9333EA",
        orange: "#F97316",
        emerald: "#10B981",
        rose: "#F43F5E",
        cyan: "#06B6D4",
        amber: "#F59E0B"
      };

      const currentBorderColor = isSelected ? "#3B82F6" : borderColorMapping[displayZone.color] || borderColorMapping.blue;

      switch (shape) {
        case "circle":
          return {
            borderRadius: "50%",
            border: `2px ${isSelected ? "solid" : "dashed"} ${currentBorderColor}`
          };
        case "triangle":
          return {
            clipPath: "polygon(50% 0%, 0% 100%, 100% 100%)",
            backgroundColor: colorMapping[displayZone.color] || colorMapping["blue"]
          };
        default:
          // rectangle
          return {
            border: `2px ${isSelected ? "solid" : "dashed"} ${currentBorderColor}`
          };
      }
    };

    // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏à‡∏∏‡∏î‡∏à‡∏±‡∏ö‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î
    const resizeHandles = [
      { position: "nw", cursor: "nw-resize", style: { top: -5, left: -5 } },
      { position: "n", cursor: "n-resize", style: { top: -5, left: "50%", transform: "translateX(-50%)" } },
      { position: "ne", cursor: "ne-resize", style: { top: -5, right: -5 } },
      { position: "w", cursor: "w-resize", style: { top: "50%", left: -5, transform: "translateY(-50%)" } },
      { position: "e", cursor: "e-resize", style: { top: "50%", right: -5, transform: "translateY(-50%)" } },
      { position: "sw", cursor: "sw-resize", style: { bottom: -5, left: -5 } },
      { position: "s", cursor: "s-resize", style: { bottom: -5, left: "50%", transform: "translateX(-50%)" } },
      { position: "se", cursor: "se-resize", style: { bottom: -5, right: -5 } }
    ];

    return (
      <div
        key={zone.id}
        className={`absolute ${displayZone.shape !== "triangle" ? zoneColors.bgOpacity : ""} ${
          displayZone.shape !== "triangle" ? zoneColors.border : ""
        } 
          ${isBeingDragged || isDraggingZoneGroup ? "opacity-80" : "opacity-60"} 
          transition-opacity cursor-move group
          ${isSelected && selectedZones.length > 1 ? "cursor-move" : ""}`}
        style={{
          left: zone.x * zoomLevel + panOffset.x,
          top: zone.y * zoomLevel + panOffset.y,
          width: zone.width * zoomLevel,
          height: zone.height * zoomLevel,
          zIndex: isBeingDragged || isDraggingZoneGroup ? 1000 : 5,
          transform: `rotate(${zone.rotation || 0}deg)`,
          transformOrigin: "center",
          ...getShapeStyles(displayZone.shape),
          ...(isSelected && {
            boxShadow: "0 0 0 3px rgba(59, 130, 246, 0.3)",
            ...(displayZone.shape !== "triangle" && { borderWidth: "3px" })
          })
        }}
        onMouseDown={e => handleZoneMouseDown(e, zone)}
        onDoubleClick={e => handleZoneDoubleClick(e, zone)}
      >
        <div
          className={`absolute px-2 py-1 rounded font-medium ${
            displayZone.shape === "triangle" ? "top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2" : "top-1 left-1"
          }`}
          style={{
            fontSize: `${Math.max(10, 12 * zoomLevel)}px`,
            backgroundColor: (() => {
              const colorMapping = {
                blue: "rgba(59, 130, 246, 0.9)",
                purple: "rgba(147, 51, 234, 0.9)",
                orange: "rgba(249, 115, 22, 0.9)",
                emerald: "rgba(16, 185, 129, 0.9)",
                rose: "rgba(244, 63, 94, 0.9)",
                cyan: "rgba(6, 182, 212, 0.9)",
                amber: "rgba(245, 158, 11, 0.9)"
              };
              return colorMapping[displayZone.color] || colorMapping["blue"];
            })(),
            color: "white",
            textShadow: "1px 1px 2px rgba(0,0,0,0.7)"
          }}
        >
          {displayZone.name}
        </div>

        {/* ‡πÄ‡∏™‡πâ‡∏ô‡∏Ç‡∏≠‡∏ö‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏≤‡∏°‡πÄ‡∏´‡∏•‡∏µ‡πà‡∏¢‡∏° */}
        {displayZone.shape === "triangle" && (
          <svg
            className="absolute inset-0 pointer-events-none"
            style={{ width: "100%", height: "100%" }}
            viewBox="0 0 100 100"
            preserveAspectRatio="none"
          >
            <polygon
              points="50,0 0,100 100,100"
              fill={(() => {
                const colorMapping = {
                  blue: "rgba(59, 130, 246, 0.3)",
                  purple: "rgba(147, 51, 234, 0.3)",
                  orange: "rgba(249, 115, 22, 0.3)",
                  emerald: "rgba(16, 185, 129, 0.3)",
                  rose: "rgba(244, 63, 94, 0.3)",
                  cyan: "rgba(6, 182, 212, 0.3)",
                  amber: "rgba(245, 158, 11, 0.3)"
                };
                return colorMapping[displayZone.color] || colorMapping["blue"];
              })()}
              stroke={
                isSelected
                  ? "#3B82F6"
                  : {
                      blue: "#3B82F6",
                      purple: "#9333EA",
                      orange: "#F97316",
                      emerald: "#10B981",
                      rose: "#F43F5E",
                      cyan: "#06B6D4",
                      amber: "#F59E0B"
                    }[displayZone.color] || "#3B82F6"
              }
              strokeWidth="2"
              strokeDasharray={isSelected ? "none" : "4,2"}
              vectorEffect="non-scaling-stroke"
            />
          </svg>
        )}

        {/* ‡∏à‡∏∏‡∏î‡∏à‡∏±‡∏ö‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡∏°‡∏∏‡∏ô */}
        <div
          className="absolute left-1/2 transform -translate-x-1/2 bg-white rounded-full shadow-xl border-2 border-gray-300
            flex items-center justify-center cursor-pointer opacity-0 group-hover:opacity-100 transition-opacity duration-200"
          style={{
            top: `-${Math.max(32, Math.min(48, 36 * zoomLevel))}px`,
            width: `${Math.max(28, Math.min(40, 32 * zoomLevel))}px`,
            height: `${Math.max(28, Math.min(40, 32 * zoomLevel))}px`,
            boxShadow: "0 4px 12px rgba(0, 0, 0, 0.3), 0 0 0 2px white"
          }}
          onMouseDown={e => handleZoneMouseDown(e, zone, "rotate")}
          title="‡∏´‡∏°‡∏∏‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà"
        >
          <svg
            className="text-gray-600"
            style={{
              width: `${Math.max(16, Math.min(24, 20 * zoomLevel))}px`,
              height: `${Math.max(16, Math.min(24, 20 * zoomLevel))}px`
            }}
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
          >
            <path
              strokeLinecap="round"
              strokeLinejoin="round"
              strokeWidth="2"
              d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"
            />
          </svg>
        </div>

        {/* ‡∏à‡∏∏‡∏î‡∏à‡∏±‡∏ö‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏ô‡∏≤‡∏î */}
        {resizeHandles.map(handle => {
          // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ç‡∏ô‡∏≤‡∏î‡∏à‡∏∏‡∏î‡∏à‡∏±‡∏ö‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏° - ‡∏Ç‡∏ô‡∏≤‡∏î‡πÉ‡∏´‡∏ç‡πà‡∏Ç‡∏∂‡πâ‡∏ô‡πÅ‡∏•‡∏∞‡∏°‡∏≠‡∏á‡πÄ‡∏´‡πá‡∏ô‡πÑ‡∏î‡πâ‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô
          const baseSize = Math.max(zone.width * zoomLevel, zone.height * zoomLevel) > 200 ? 20 : 16;
          const handleSize = Math.max(baseSize, Math.min(24, 12 * zoomLevel + 8));
          const handleOffset = handleSize / 2;

          return (
            <div
              key={handle.position}
              className={`absolute bg-white border-3 ${zoneColors.border} rounded-full 
              opacity-0 group-hover:opacity-100 transition-opacity duration-200 shadow-xl ring-1 ring-gray-300`}
              style={{
                ...handle.style,
                // ‡∏õ‡∏£‡∏±‡∏ö‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏Ç‡∏ô‡∏≤‡∏î‡∏à‡∏∏‡∏î‡∏à‡∏±‡∏ö
                ...(handle.style.top === -5 && { top: -handleOffset }),
                ...(handle.style.bottom === -5 && { bottom: -handleOffset }),
                ...(handle.style.left === -5 && { left: -handleOffset }),
                ...(handle.style.right === -5 && { right: -handleOffset }),
                width: `${handleSize}px`,
                height: `${handleSize}px`,
                cursor: handle.cursor,
                zIndex: 1001,
                boxShadow: "0 4px 8px rgba(0, 0, 0, 0.3), 0 0 0 2px white"
              }}
              onMouseDown={e => handleZoneMouseDown(e, zone, handle.position)}
            />
          );
        })}
      </div>
    );
  };

  // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ double click ‡∏ó‡∏µ‡πà‡∏Å‡∏•‡∏∏‡πà‡∏°
  const handleZoneDoubleClick = (e, zone) => {
    e.preventDefault();
    e.stopPropagation();
    setOriginalZoneData({ ...zone }); // ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°‡πÑ‡∏ß‡πâ
    setEditZoneData({ ...zone });
    setShowEditZoneModal(true);
  };

  // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Å‡∏•‡∏∏‡πà‡∏°
  const handleEditZoneSubmit = e => {
    e.preventDefault();
    if (editZoneData && originalZoneData) {
      // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Å‡∏•‡∏∏‡πà‡∏°
      addToHistory(ACTION_TYPES.EDIT_ZONE, {
        id: editZoneData.id,
        previous: originalZoneData,
        current: editZoneData
      });

      setZones(prevZones =>
        prevZones.map(zone =>
          zone.id === editZoneData.id ? { ...zone, name: editZoneData.name, color: editZoneData.color } : zone
        )
      );
      setShowEditZoneModal(false);
      setEditZoneData(null);
      setOriginalZoneData(null);
    }
  };

  // ‡πÄ‡∏û‡∏¥‡πà‡∏° useEffect ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ loading state
  useEffect(() => {
    const initializeComponent = async () => {
      try {
        // ‡∏£‡∏≠‡πÉ‡∏´‡πâ component ‡∏ñ‡∏π‡∏Å mount ‡πÅ‡∏•‡∏∞ state ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏ñ‡∏π‡∏Å‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤
        await Promise.all([
          new Promise(resolve => setTimeout(resolve, 100)), // ‡∏£‡∏≠‡πÉ‡∏´‡πâ DOM ‡πÄ‡∏£‡∏ô‡πÄ‡∏î‡∏≠‡∏£‡πå
          new Promise(resolve => {
            if (imageRef.current) {
              if (imageRef.current.complete) {
                resolve();
              } else {
                imageRef.current.onload = resolve;
              }
            } else {
              resolve();
            }
          })
        ]);
      } finally {
        setIsLoading(false);
      }
    };

    initializeComponent();
  }, []);

  // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
  const clearSelection = () => {
    setSelectedMarkers([]);
    setSelectedZones([]);
    setIsGroupSelecting(false);
    setGroupSelectionStart(null);
    setGroupSelectionEnd(null);
    setJustFinishedGroupSelection(false);
    setDragReference(null);
  };

  // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ marker ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
  const isMarkerInSelection = (marker, selectionStart, selectionEnd) => {
    const minX = Math.min(selectionStart.x, selectionEnd.x);
    const maxX = Math.max(selectionStart.x, selectionEnd.x);
    const minY = Math.min(selectionStart.y, selectionEnd.y);
    const maxY = Math.max(selectionStart.y, selectionEnd.y);

    return marker.x >= minX && marker.x <= maxX && marker.y >= minY && marker.y <= maxY;
  };

  // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ zone ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
  const isZoneInSelection = (zone, selectionStart, selectionEnd) => {
    const minX = Math.min(selectionStart.x, selectionEnd.x);
    const maxX = Math.max(selectionStart.x, selectionEnd.x);
    const minY = Math.min(selectionStart.y, selectionEnd.y);
    const maxY = Math.max(selectionStart.y, selectionEnd.y);

    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏à‡∏∏‡∏î‡∏Å‡∏∂‡πà‡∏á‡∏Å‡∏•‡∏≤‡∏á‡∏Ç‡∏≠‡∏á zone ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    const zoneCenterX = zone.x + zone.width / 2;
    const zoneCenterY = zone.y + zone.height / 2;

    return zoneCenterX >= minX && zoneCenterX <= maxX && zoneCenterY >= minY && zoneCenterY <= maxY;
  };

  // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ zoom
  const handleWheel = e => {
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏Å‡∏î Ctrl ‡∏´‡∏£‡∏∑‡∏≠ Cmd ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    if (!e.ctrlKey && !e.metaKey) {
      // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏Å‡∏î Ctrl ‡πÉ‡∏´‡πâ‡∏õ‡∏•‡πà‡∏≠‡∏¢‡πÉ‡∏´‡πâ scroll ‡∏õ‡∏Å‡∏ï‡∏¥
      return;
    }

    e.preventDefault();
    e.stopPropagation();
    const delta = e.deltaY > 0 ? -0.1 : 0.1;
    const newZoom = Math.max(0.5, Math.min(3, zoomLevel + delta));

    if (newZoom !== zoomLevel) {
      // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏Ç‡∏≠‡∏á‡πÄ‡∏°‡∏≤‡∏™‡πå‡πÄ‡∏°‡∏∑‡πà‡∏≠ zoom
      const containerRect = containerRef.current.getBoundingClientRect();
      const mouseX = e.clientX - containerRect.left;
      const mouseY = e.clientY - containerRect.top;

      // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÉ‡∏´‡∏°‡πà‡∏Ç‡∏≠‡∏á pan offset ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ zoom ‡∏ó‡∏µ‡πà‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÄ‡∏°‡∏≤‡∏™‡πå
      const scaleFactor = newZoom / zoomLevel;
      const newPanX = mouseX - (mouseX - panOffset.x) * scaleFactor;
      const newPanY = mouseY - (mouseY - panOffset.y) * scaleFactor;

      setZoomLevel(newZoom);
      setPanOffset({ x: newPanX, y: newPanY });
    }
  };

  // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£ scroll ‡∏Ç‡∏≠‡∏á‡∏´‡∏ô‡πâ‡∏≤ page
  const preventPageScroll = e => {
    e.preventDefault();
    e.stopPropagation();
  };

  // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï zoom ‡πÅ‡∏•‡∏∞ pan
  const resetZoomAndPan = () => {
    setZoomLevel(1);
    setPanOffset({ x: 0, y: 0 });
  };

  return (
    <div className="relative w-full max-w-4xl mx-auto">
      {isLoading ? (
        <div className="flex items-center justify-center min-h-[400px]">
          <div className="text-center">
            <div className="inline-block animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-blue-500 mb-2" />
            <div className="text-gray-600">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>
          </div>
        </div>
      ) : (
        <div className="flex gap-4">
          {/* ‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏´‡∏•‡∏±‡∏Å */}
          <div className="flex-1">
            <h2 className="text-2xl font-bold text-center mb-4 text-gray-800">‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏´‡∏°‡∏π‡πà‡∏ö‡πâ‡∏≤‡∏ô - ‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏∏‡∏î‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç</h2>

            {/* ‡∏†‡∏≤‡∏û‡∏´‡∏°‡∏π‡πà‡∏ö‡πâ‡∏≤‡∏ô */}
            <div
              ref={containerRef}
              className="relative inline-block w-full border-2 border-gray-300 rounded-lg overflow-hidden shadow-lg"
              onMouseMove={handleMouseMove}
              onMouseUp={handleMouseUp}
              onMouseLeave={handleMouseUp}
              onWheel={handleWheel}
              style={{
                cursor: isPanning ? "grabbing" : isCtrlPressed ? "grab" : "crosshair"
              }}
            >
              <img
                ref={imageRef}
                src="/3-4430 1.png"
                alt="‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏´‡∏°‡∏π‡πà‡∏ö‡πâ‡∏≤‡∏ô"
                className="w-full h-auto select-none"
                style={{
                  transform: `scale(${zoomLevel}) translate(${panOffset.x / zoomLevel}px, ${panOffset.y / zoomLevel}px)`,
                  transformOrigin: "0 0"
                }}
                onClick={handleImageClick}
                onMouseDown={handleImageMouseDown}
                onError={e => {
                  e.target.style.display = "none";
                  e.target.nextSibling.style.display = "flex";
                }}
                draggable={false}
              />

              {/* ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏ó‡∏î‡πÅ‡∏ó‡∏ô‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ */}
              <div
                className="w-full h-96 bg-gradient-to-br from-green-200 to-green-400 hidden items-center justify-center select-none"
                onClick={handleImageClick}
                onMouseDown={handleImageMouseDown}
                style={{
                  transform: `scale(${zoomLevel}) translate(${panOffset.x / zoomLevel}px, ${panOffset.y / zoomLevel}px)`,
                  transformOrigin: "0 0"
                }}
              >
                <div className="text-center text-gray-700">
                  <div className="text-6xl mb-4">üèòÔ∏è</div>
                  <p className="text-lg font-semibold">‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏´‡∏°‡∏π‡πà‡∏ö‡πâ‡∏≤‡∏ô</p>
                  <p className="text-sm">‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏∏‡∏î‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç</p>
                </div>
              </div>

              {/* ‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• */}
              {zones.map(zone => renderZone(zone))}

              {/* ‡πÅ‡∏™‡∏î‡∏á‡∏û‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏Ç‡∏ì‡∏∞‡∏•‡∏≤‡∏Å */}
              {(isSelectingZone || (showZoneModal && currentSelection)) &&
                ((isSelectingZone && selectionStart && selectionEnd) || (!isSelectingZone && currentSelection)) &&
                (() => {
                  // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡∏µ‡∏ï‡∏≤‡∏° zoneFormData.color
                  const previewColors = {
                    blue: { bg: "bg-blue-200", border: "border-blue-500" },
                    purple: { bg: "bg-purple-200", border: "border-purple-500" },
                    orange: { bg: "bg-orange-200", border: "border-orange-500" },
                    emerald: { bg: "bg-emerald-200", border: "border-emerald-500" },
                    rose: { bg: "bg-rose-200", border: "border-rose-500" },
                    cyan: { bg: "bg-cyan-200", border: "border-cyan-500" },
                    amber: { bg: "bg-amber-200", border: "border-amber-500" }
                  };

                  const currentColors = previewColors[zoneFormData.color] || previewColors.blue;

                  const width =
                    Math.abs(
                      isSelectingZone && selectionStart && selectionEnd
                        ? selectionEnd.x - selectionStart.x
                        : currentSelection.endX - currentSelection.startX
                    ) * zoomLevel;

                  const height =
                    Math.abs(
                      isSelectingZone && selectionStart && selectionEnd
                        ? selectionEnd.y - selectionStart.y
                        : currentSelection.endY - currentSelection.startY
                    ) * zoomLevel;

                  const left =
                    Math.min(
                      isSelectingZone && selectionStart ? selectionStart.x : currentSelection.startX,
                      isSelectingZone && selectionEnd ? selectionEnd.x : currentSelection.endX
                    ) *
                      zoomLevel +
                    panOffset.x;

                  const top =
                    Math.min(
                      isSelectingZone && selectionStart ? selectionStart.y : currentSelection.startY,
                      isSelectingZone && selectionEnd ? selectionEnd.y : currentSelection.endY
                    ) *
                      zoomLevel +
                    panOffset.y;

                  // ‡∏™‡∏µ‡∏Ç‡∏≠‡∏á‡πÄ‡∏™‡πâ‡∏ô‡∏Ç‡∏≠‡∏ö
                  const borderColor =
                    {
                      blue: "#3B82F6",
                      purple: "#9333EA",
                      orange: "#F97316",
                      emerald: "#10B981",
                      rose: "#F43F5E",
                      cyan: "#06B6D4",
                      amber: "#F59E0B"
                    }[zoneFormData.color] || "#3B82F6";

                  // ‡∏™‡∏µ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á
                  const bgColor =
                    {
                      blue: "rgba(59, 130, 246, 0.3)",
                      purple: "rgba(147, 51, 234, 0.3)",
                      orange: "rgba(249, 115, 22, 0.3)",
                      emerald: "rgba(16, 185, 129, 0.3)",
                      rose: "rgba(244, 63, 94, 0.3)",
                      cyan: "rgba(6, 182, 212, 0.3)",
                      amber: "rgba(245, 158, 11, 0.3)"
                    }[zoneFormData.color] || "rgba(59, 130, 246, 0.3)";

                  return (
                    <div
                      className="absolute opacity-50 pointer-events-none"
                      style={{
                        left,
                        top,
                        width,
                        height
                      }}
                    >
                      {selectedZoneShape === "triangle" ? (
                        <>
                          {/* ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏™‡∏≤‡∏°‡πÄ‡∏´‡∏•‡∏µ‡πà‡∏¢‡∏° */}
                          <div
                            className="absolute inset-0"
                            style={{
                              clipPath: "polygon(50% 0%, 0% 100%, 100% 100%)",
                              backgroundColor: bgColor
                            }}
                          />
                          {/* ‡πÄ‡∏™‡πâ‡∏ô‡∏Ç‡∏≠‡∏ö‡∏™‡∏≤‡∏°‡πÄ‡∏´‡∏•‡∏µ‡πà‡∏¢‡∏° */}
                          <svg
                            className="absolute inset-0"
                            style={{ width: "100%", height: "100%" }}
                            viewBox="0 0 100 100"
                            preserveAspectRatio="none"
                          >
                            <polygon
                              points="50,0 0,100 100,100"
                              fill="none"
                              stroke={borderColor}
                              strokeWidth="2"
                              strokeDasharray="4,2"
                              vectorEffect="non-scaling-stroke"
                            />
                          </svg>
                        </>
                      ) : selectedZoneShape === "circle" ? (
                        <div
                          className={`${currentColors.bg} border-2 ${
                            currentColors.border
                          } border-dashed rounded-full w-full h-full`}
                        />
                      ) : (
                        <div className={`${currentColors.bg} border-2 ${currentColors.border} border-dashed w-full h-full`} />
                      )}
                    </div>
                  );
                })()}

              {/* ‡πÅ‡∏™‡∏î‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö‡∏Å‡∏•‡∏∏‡πà‡∏° */}
              {isGroupSelecting && groupSelectionStart && groupSelectionEnd && (
                <div
                  className="absolute bg-green-200 border-2 border-green-500 border-dashed opacity-50 pointer-events-none"
                  style={{
                    left: Math.min(groupSelectionStart.x, groupSelectionEnd.x) * zoomLevel + panOffset.x,
                    top: Math.min(groupSelectionStart.y, groupSelectionEnd.y) * zoomLevel + panOffset.y,
                    width: Math.abs(groupSelectionEnd.x - groupSelectionStart.x) * zoomLevel,
                    height: Math.abs(groupSelectionEnd.y - groupSelectionStart.y) * zoomLevel
                  }}
                />
              )}

              {/* Markers */}
              {markers.map(marker => renderMarker(marker, true))}
            </div>

            {/* ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô */}
            <div className="mt-4 p-3 bg-blue-50 rounded-lg text-sm text-blue-700">
              <div className="font-medium mb-1">‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô:</div>
              <ul className="space-y-1 text-xs">
                <li>
                  ‚Ä¢ <span className="font-semibold">‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏î‡∏µ‡∏¢‡∏ß</span> ‡∏ó‡∏µ‡πà‡∏†‡∏≤‡∏û‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏∏‡∏î‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡πÉ‡∏´‡∏°‡πà
                </li>
                <li>
                  ‚Ä¢ <span className="font-semibold">‡∏Å‡∏î‡∏Ñ‡πâ‡∏≤‡∏á‡πÅ‡∏•‡πâ‡∏ß‡∏•‡∏≤‡∏Å</span> ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÉ‡∏´‡∏°‡πà
                </li>
                <li>‚Ä¢ ‡∏•‡∏≤‡∏Å‡∏à‡∏∏‡∏î‡∏™‡∏µ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡πâ‡∏≤‡∏¢‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á</li>
                <li>
                  ‚Ä¢ <span className="font-semibold">Ctrl+Mouse wheel</span> ‡πÄ‡∏û‡∏∑‡πà‡∏≠ Zoom in/out
                </li>
                <li>
                  ‚Ä¢ <span className="font-semibold">Ctrl+‡∏Ñ‡∏•‡∏¥‡∏Å‡πÅ‡∏•‡πâ‡∏ß‡∏•‡∏≤‡∏Å</span> ‡∏´‡∏£‡∏∑‡∏≠{" "}
                  <span className="font-semibold">Middle click ‡∏•‡∏≤‡∏Å</span> ‡πÄ‡∏û‡∏∑‡πà‡∏≠ Pan ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û
                </li>
                <li>
                  ‚Ä¢ <span className="font-semibold">Ctrl+0</span> ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï Zoom ‡πÅ‡∏•‡∏∞ Pan
                </li>
                <li>
                  ‚Ä¢ <span className="font-semibold">Shift+‡∏•‡∏≤‡∏Å</span> ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏•‡∏≤‡∏¢ markers ‡πÅ‡∏•‡∏∞ zones
                </li>
                <li>
                  ‚Ä¢ <span className="font-semibold">‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà marker/zone ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß‡∏•‡∏≤‡∏Å</span> ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡πâ‡∏≤‡∏¢‡∏ó‡∏±‡πâ‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô
                </li>
                <li>‚Ä¢ ‡∏•‡∏≤‡∏Å marker ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡πÉ‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</li>
                <li>‚Ä¢ ‡∏Å‡∏î ESC ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</li>
                <li>‚Ä¢ ‡∏Å‡∏î Ctrl+Z ‡πÄ‡∏û‡∏∑‡πà‡∏≠ Undo ‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥, Ctrl+Shift+Z ‡πÄ‡∏û‡∏∑‡πà‡∏≠ Redo</li>
                <li>‚Ä¢ ‡πÉ‡∏ä‡πâ‡∏õ‡∏∏‡πà‡∏° ‡πÅ‡∏™‡∏î‡∏á/‡∏ã‡πà‡∏≠‡∏ô ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏Å‡∏•‡∏∏‡πà‡∏°</li>
                <li>
                  ‚Ä¢ <span className="font-semibold">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ‡∏ó‡∏£‡∏á</span> ‡∏Å‡πà‡∏≠‡∏ô‡∏•‡∏≤‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏£‡∏π‡∏õ‡∏ó‡∏£‡∏á‡∏ï‡πà‡∏≤‡∏á‡πÜ
                </li>
              </ul>
            </div>

            {/* ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å */}
            {(selectedMarkers.length > 0 || selectedZones.length > 0) && (
              <div className="mt-2 p-2 bg-green-50 rounded-lg text-sm text-green-700">
                <div className="font-medium">
                  ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß: {selectedMarkers.length} markers
                  {selectedZones.length > 0 && `, ${selectedZones.length} zones`}
                </div>
                <div className="text-xs mt-1">
                  {isDraggingGroup
                    ? "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏≤‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏° markers..."
                    : isDraggingZoneGroup
                    ? "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏≤‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏° zones..."
                    : isDraggingMixed
                    ? "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏≤‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ú‡∏™‡∏° (markers ‡πÅ‡∏•‡∏∞ zones)..."
                    : selectedMarkers.length > 0 && selectedZones.length > 0
                    ? "‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà marker ‡∏´‡∏£‡∏∑‡∏≠ zone ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ß‡πâ‡πÅ‡∏•‡πâ‡∏ß‡∏•‡∏≤‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏¢‡πâ‡∏≤‡∏¢‡∏ó‡∏±‡πâ‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô"
                    : selectedMarkers.length > 0
                    ? "‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà marker ‡πÉ‡∏î‡πÜ ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ß‡πâ‡πÅ‡∏•‡πâ‡∏ß‡∏•‡∏≤‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏¢‡πâ‡∏≤‡∏¢‡∏ó‡∏±‡πâ‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏°"
                    : "‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà zone ‡πÉ‡∏î‡πÜ ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ß‡πâ‡πÅ‡∏•‡πâ‡∏ß‡∏•‡∏≤‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏¢‡πâ‡∏≤‡∏¢‡∏ó‡∏±‡πâ‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏°"}
                </div>
              </div>
            )}

            {/* ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Zoom */}
            <div className="mt-2 p-2 bg-blue-50 rounded-lg text-sm text-blue-700">
              <div className="flex items-center justify-between">
                <div>
                  <span className="font-medium">Zoom: {Math.round(zoomLevel * 100)}%</span>
                  {(panOffset.x !== 0 || panOffset.y !== 0) && (
                    <span className="ml-2 text-xs">
                      Pan: ({Math.round(panOffset.x)}, {Math.round(panOffset.y)})
                    </span>
                  )}
                </div>
                <div className="flex space-x-2">
                  <button
                    onClick={undo}
                    disabled={currentIndex < 0}
                    className="w-8 h-8 bg-gray-500 text-white rounded-full text-sm hover:bg-gray-600 transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed cursor-pointer flex items-center justify-center shadow-md hover:shadow-lg"
                    title="‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥ (Ctrl+Z)"
                  >
                    ‚Ü∂
                  </button>
                  <button
                    onClick={redo}
                    disabled={currentIndex >= history.length - 1}
                    className="w-8 h-8 bg-gray-500 text-white rounded-full text-sm hover:bg-gray-600 transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed cursor-pointer flex items-center justify-center shadow-md hover:shadow-lg"
                    title="‡∏ó‡∏≥‡∏ã‡πâ‡∏≥‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥ (Ctrl+Shift+Z)"
                  >
                    ‚Ü∑
                  </button>
                  <button
                    onClick={resetZoomAndPan}
                    className="w-8 h-8 bg-blue-500 text-white rounded-full text-sm hover:bg-blue-600 transition-all duration-200 cursor-pointer flex items-center justify-center shadow-md hover:shadow-lg"
                    title="‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï Zoom ‡πÅ‡∏•‡∏∞ Pan (Ctrl+0)"
                  >
                    üè†
                  </button>
                  <button
                    onClick={clearSelection}
                    className="w-8 h-8 bg-purple-500 text-white rounded-full text-sm hover:bg-purple-600 transition-all duration-200 cursor-pointer flex items-center justify-center shadow-md hover:shadow-lg"
                    title="‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å (ESC)"
                  >
                    ‚úï
                  </button>
                </div>
              </div>
              <div className="mb-2">
                <label className="block text-sm font-medium text-blue-800 mb-1">‡∏£‡∏π‡∏õ‡∏ó‡∏£‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏°:</label>
                <div className="flex space-x-2">
                  {zoneShapeOptions.map(shape => (
                    <button
                      key={shape.value}
                      onClick={() => setSelectedZoneShape(shape.value)}
                      className={`px-2 py-1 rounded text-xs transition-colors ${
                        selectedZoneShape === shape.value
                          ? "bg-blue-500 text-white"
                          : "bg-white text-blue-700 hover:bg-blue-100"
                      }`}
                      title={shape.label}
                    >
                      {shape.icon} {shape.label}
                    </button>
                  ))}
                </div>
              </div>
            </div>
          </div>

          {/* ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏î‡πâ‡∏≤‡∏ô‡∏Ç‡∏ß‡∏≤ */}
          <div className="w-80">
            <div className="bg-white rounded-lg shadow-md p-4">
              <h3 className="text-lg font-semibold mb-3 text-gray-800">‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ({zones.length})</h3>
              <div className="space-y-4">
                {/* ‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏° Marker ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö marker ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÉ‡∏î‡πÜ */}
                <div className="bg-gray-50 p-4 rounded-lg border hover:bg-gray-100 border-gray-200">
                  <div className="flex items-center justify-between mb-2">
                    <div className="flex items-center space-x-2">
                      <div className="w-4 h-4 bg-gray-200 border border-gray-300 rounded" />
                      <span className="font-medium text-gray-800">Marker</span>
                    </div>
                    <div className="flex items-center space-x-2">
                      <span className="text-sm text-gray-600">
                        ({markers.filter(marker => !zones.some(zone => isPointInZone(marker.x, marker.y, zone))).length} ‡∏à‡∏∏‡∏î)
                      </span>
                    </div>
                  </div>
                  {/* ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ Markers ‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÉ‡∏î‡πÜ */}
                  <div className="mt-2 space-y-1">
                    {markers
                      .filter(marker => !zones.some(zone => isPointInZone(marker.x, marker.y, zone)))
                      .map(marker => {
                        const markerColors = getMarkerColors(marker.color);
                        const currentSize = markerSizes[marker.id] || DEFAULT_MARKER_SIZE;
                        const isDragging = draggedListMarker?.id === marker.id;

                        return (
                          <div
                            key={marker.id}
                            className={`flex items-center justify-between bg-white p-2 rounded border text-sm cursor-move transition-all duration-200 ${
                              isDragging ? "opacity-50" : "hover:shadow-md"
                            }`}
                            draggable
                            onDragStart={e => handleMarkerDragStart(e, marker)}
                            onDragEnd={handleMarkerDragEnd}
                          >
                            <div className="flex items-center space-x-2">
                              <div
                                className={`${markerColors.bg} rounded-full transition-all duration-200`}
                                style={{
                                  width: `${currentSize * 3}px`,
                                  height: `${currentSize * 3}px`
                                }}
                              />
                              <span>{marker.name}</span>
                            </div>
                            <div className="flex space-x-1">
                              {!isDragging && (
                                <button
                                  onClick={e => {
                                    e.stopPropagation();
                                    resetMarkerPosition(marker.id);
                                  }}
                                  className="text-blue-500 hover:text-blue-700"
                                  title="‡∏Å‡∏•‡∏±‡∏ö‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÄ‡∏î‡∏¥‡∏°"
                                  onMouseDown={e => e.stopPropagation()}
                                  onDragStart={e => e.preventDefault()}
                                >
                                  ‚Ü∫
                                </button>
                              )}
                              <button
                                onClick={e => {
                                  e.stopPropagation();
                                  removeMarker(marker.id);
                                }}
                                className="text-red-500 hover:text-red-700"
                                onMouseDown={e => e.stopPropagation()}
                                onDragStart={e => e.preventDefault()}
                              >
                                ‚úï
                              </button>
                            </div>
                          </div>
                        );
                      })}
                  </div>
                </div>

                {/* ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏≠‡∏∑‡πà‡∏ô‡πÜ */}
                {zones.map(zone => {
                  const zoneColors = getZoneColors(zone.color);
                  const markersInZone = markers.filter(marker => isPointInZone(marker.x, marker.y, zone));
                  const isDropTarget = dragOverZoneId === zone.id;
                  return (
                    <div
                      key={zone.id}
                      className={`bg-gray-50 p-4 rounded-lg border transition-all duration-200 ${
                        isDropTarget ? "border-blue-500 bg-blue-50" : "hover:bg-gray-100 border-gray-200"
                      }`}
                      onDragOver={e => handleZoneDragOver(e, zone)}
                      onDragLeave={handleZoneDragLeave}
                      onDrop={e => handleZoneDrop(e, zone)}
                    >
                      <div className="flex items-center justify-between mb-2">
                        <div className="flex items-center space-x-2">
                          <div className={`w-4 h-4 ${zoneColors.bgOpacity} ${zoneColors.border} border rounded`} />
                          <span className="font-medium text-gray-800">{zone.name}</span>
                        </div>
                        <div className="flex items-center space-x-2">
                          <span className="text-sm text-gray-600">({markersInZone.length} ‡∏à‡∏∏‡∏î)</span>
                          <button onClick={() => removeZone(zone.id)} className="text-red-500 hover:text-red-700 text-sm">
                            ‡∏•‡∏ö
                          </button>
                        </div>
                      </div>
                      <div className="flex justify-between items-center text-sm mb-2">
                        <button
                          onClick={() => toggleZoneVisibility(zone.id)}
                          className={`px-2 py-1 rounded ${
                            visibleZones[zone.id]
                              ? "bg-blue-500 text-white hover:bg-blue-600"
                              : "bg-gray-300 text-gray-700 hover:bg-gray-400"
                          } transition-colors`}
                        >
                          {visibleZones[zone.id] ? "‡∏ã‡πà‡∏≠‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°" : "‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏°"}
                        </button>
                      </div>
                      {/* ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ Markers ‡πÉ‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏° */}
                      {markersInZone.length > 0 && (
                        <div className="mt-2 space-y-1">
                          <div className="text-sm font-medium text-gray-700 mb-1">‡∏à‡∏∏‡∏î‡πÉ‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°:</div>
                          {markersInZone.map(marker => {
                            const markerColors = getMarkerColors(marker.color);
                            const isInOriginalPosition = marker.x === marker.originalX && marker.y === marker.originalY;
                            const isDragging = draggedListMarker?.id === marker.id;
                            const currentSize = markerSizes[marker.id] || DEFAULT_MARKER_SIZE;

                            return (
                              <div
                                key={marker.id}
                                className={`flex items-center justify-between bg-white p-2 rounded border text-sm cursor-move transition-all duration-200 ${
                                  isDragging ? "opacity-50" : "hover:shadow-md"
                                }`}
                                draggable
                                onDragStart={e => handleMarkerDragStart(e, marker)}
                                onDragEnd={handleMarkerDragEnd}
                              >
                                <div className="flex items-center space-x-2">
                                  <div
                                    className={`${markerColors.bg} rounded-full transition-all duration-200`}
                                    style={{
                                      width: `${currentSize * 3}px`,
                                      height: `${currentSize * 3}px`
                                    }}
                                  />
                                  <span>{marker.name}</span>
                                  {!isInOriginalPosition && <span className="text-xs text-orange-500">(‡∏¢‡πâ‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß)</span>}
                                </div>
                                <div className="flex items-center space-x-2">
                                  <div className="flex space-x-1">
                                    {!isInOriginalPosition && (
                                      <button
                                        onClick={e => {
                                          e.stopPropagation();
                                          resetMarkerPosition(marker.id);
                                        }}
                                        className="text-blue-500 hover:text-blue-700"
                                        title="‡∏Å‡∏•‡∏±‡∏ö‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÄ‡∏î‡∏¥‡∏°"
                                        onMouseDown={e => e.stopPropagation()}
                                        onDragStart={e => e.preventDefault()}
                                      >
                                        ‚Ü∫
                                      </button>
                                    )}
                                    <button
                                      onClick={e => {
                                        e.stopPropagation();
                                        removeMarker(marker.id);
                                      }}
                                      className="text-red-500 hover:text-red-700"
                                      onMouseDown={e => e.stopPropagation()}
                                      onDragStart={e => e.preventDefault()}
                                    >
                                      ‚úï
                                    </button>
                                  </div>
                                </div>
                              </div>
                            );
                          })}
                        </div>
                      )}
                    </div>
                  );
                })}
              </div>
            </div>
          </div>
        </div>
      )}

      {/* Tooltip Form ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏° */}
      {showZoneModal && currentSelection && (
        <div
          className="absolute bg-white rounded-lg shadow-xl border border-gray-200 p-4 z-50 w-72 animate-scaleIn"
          style={{
            left:
              (Math.min(currentSelection.startX, currentSelection.endX) +
                Math.abs(currentSelection.endX - currentSelection.startX) / 2) *
                zoomLevel +
              panOffset.x,
            top: (Math.max(currentSelection.startY, currentSelection.endY) + 20) * zoomLevel + panOffset.y,
            transform: "translate(-50%, 0)"
          }}
        >
          <div className="relative">
            <form onSubmit={handleZoneSubmit} className="space-y-3">
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏•‡∏∏‡πà‡∏°:</label>
                <input
                  type="text"
                  value={zoneFormData.name}
                  onChange={e => setZoneFormData({ ...zoneFormData, name: e.target.value })}
                  className="w-full px-3 py-1.5 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200"
                  placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ö‡∏£‡∏¥‡πÄ‡∏ß‡∏ì‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô"
                  autoFocus
                  required
                />
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">‡∏£‡∏π‡∏õ‡∏ó‡∏£‡∏á:</label>
                <div className="flex space-x-2">
                  {zoneShapeOptions.map(shape => (
                    <button
                      key={shape.value}
                      type="button"
                      onClick={() => setSelectedZoneShape(shape.value)}
                      className={`flex-1 py-1.5 px-2 text-xs rounded border transition-all duration-200 ${
                        selectedZoneShape === shape.value
                          ? "bg-blue-500 text-white border-blue-500"
                          : "bg-white text-gray-700 border-gray-300 hover:border-blue-300"
                      }`}
                    >
                      {shape.icon} {shape.label}
                    </button>
                  ))}
                </div>
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏µ‡∏Å‡∏•‡∏∏‡πà‡∏°:</label>
                <div className="flex items-center justify-center space-x-4">
                  {zoneColorOptions.map(color => (
                    <button
                      key={color.value}
                      type="button"
                      onClick={() => setZoneFormData({ ...zoneFormData, color: color.value })}
                      className={`w-6 h-6 rounded-full transition-all duration-200 shadow-md hover:shadow-lg ${color.bg} 
                        ${
                          zoneFormData.color === color.value
                            ? "ring-2 ring-offset-2 ring-gray-400 scale-125"
                            : "hover:scale-110"
                        }`}
                      title={color.label}
                    />
                  ))}
                </div>
              </div>

              <div className="flex space-x-2 pt-1">
                <button
                  type="submit"
                  className="flex-1 bg-blue-500 text-white py-1.5 px-3 rounded-md text-sm hover:bg-blue-600 transition-all duration-200"
                >
                  ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏•‡∏∏‡πà‡∏°
                </button>
                <button
                  type="button"
                  onClick={() => {
                    setShowZoneModal(false);
                    setZoneFormData({ name: "", color: "blue" });
                    // ‡πÑ‡∏°‡πà‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï selectedZoneShape ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏Ñ‡∏á‡∏£‡∏π‡∏õ‡∏ó‡∏£‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÑ‡∏ß‡πâ
                    setCurrentSelection(null);
                    setIsSelectingZone(false);
                    setSelectionStart(null);
                    setSelectionEnd(null);
                  }}
                  className="flex-1 bg-gray-500 text-white py-1.5 px-3 rounded-md text-sm hover:bg-gray-600 transition-all duration-200 cursor-pointer"
                >
                  ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                </button>
              </div>
            </form>
          </div>
        </div>
      )}

      {/* Popup Form ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡∏£‡πâ‡∏≤‡∏á Marker */}
      {showPopup && (
        <div
          className="absolute bg-white rounded-lg shadow-xl border border-gray-200 p-4 z-50 w-72 animate-scaleIn"
          style={{
            left: currentPosition.x * zoomLevel + panOffset.x,
            top: (currentPosition.y + 10) * zoomLevel + panOffset.y,
            transform: "translate(-50%, 0)"
          }}
        >
          <div className="relative">
            <form onSubmit={handleSubmit} className="space-y-3">
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà:</label>
                <input
                  type="text"
                  value={formData.name}
                  onChange={e => setFormData({ ...formData, name: e.target.value })}
                  className="w-full px-3 py-1.5 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200"
                  placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ö‡πâ‡∏≤‡∏ô‡∏ô‡∏≤‡∏¢‡∏™‡∏°‡∏ä‡∏≤‡∏¢"
                  autoFocus
                  required
                />
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏µ:</label>
                <div className="flex items-center justify-center space-x-4">
                  {colorOptions.map(color => (
                    <button
                      key={color.value}
                      type="button"
                      onClick={() => setFormData({ ...formData, color: color.value })}
                      className={`w-6 h-6 rounded-full transition-all duration-200 shadow-md hover:shadow-lg ${color.bg} 
                        ${formData.color === color.value ? "ring-2 ring-offset-2 ring-gray-400 scale-125" : "hover:scale-110"}`}
                      title={color.label}
                    />
                  ))}
                </div>
              </div>

              <div className="flex space-x-2 pt-1">
                <button
                  type="submit"
                  className="flex-1 bg-blue-500 text-white py-1.5 px-3 rounded-md text-sm hover:bg-blue-600 transition-all duration-200"
                >
                  ‡∏™‡∏£‡πâ‡∏≤‡∏á Marker
                </button>
                <button
                  type="button"
                  onClick={() => {
                    setShowPopup(false);
                    setFormData({ name: "", group: "", color: "red" });
                  }}
                  className="flex-1 bg-gray-500 text-white py-1.5 px-3 rounded-md text-sm hover:bg-gray-600 transition-all duration-200 cursor-pointer"
                >
                  ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                </button>
              </div>
            </form>
          </div>
        </div>
      )}

      {/* Popup Form ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç Marker */}
      {showEditMarkerModal && editMarkerData && (
        <div
          className="absolute bg-white rounded-lg shadow-xl border border-gray-200 p-4 z-50 w-72"
          style={{
            left: editMarkerData.x * zoomLevel + panOffset.x + 30,
            top: editMarkerData.y * zoomLevel + panOffset.y,
            transform: "translate(0, -50%)"
          }}
        >
          <div className="relative">
            <form onSubmit={handleEditMarkerSubmit} className="space-y-3">
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà:</label>
                <input
                  type="text"
                  value={editMarkerData.name}
                  onChange={e => setEditMarkerData({ ...editMarkerData, name: e.target.value })}
                  className="w-full px-3 py-1.5 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200"
                  placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ö‡πâ‡∏≤‡∏ô‡∏ô‡∏≤‡∏¢‡∏™‡∏°‡∏ä‡∏≤‡∏¢"
                  autoFocus
                  required
                />
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">‡∏Å‡∏•‡∏∏‡πà‡∏°/‡∏´‡∏°‡∏π‡πà‡∏ö‡πâ‡∏≤‡∏ô:</label>
                <select
                  value={editMarkerData.group}
                  onChange={e => setEditMarkerData({ ...editMarkerData, group: e.target.value })}
                  className="w-full px-3 py-1.5 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200"
                  required
                >
                  <option value="Marker">Marker</option>
                  {zones.map(zone => (
                    <option key={zone.id} value={zone.name}>
                      {zone.name}
                    </option>
                  ))}
                </select>
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">‡∏Ç‡∏ô‡∏≤‡∏î:</label>
                <div className="flex items-center space-x-2">
                  <input
                    type="range"
                    min={MIN_MARKER_SIZE}
                    max={MAX_MARKER_SIZE}
                    value={editMarkerData.size}
                    onChange={e =>
                      setEditMarkerData(prev => ({
                        ...prev,
                        size: parseInt(e.target.value)
                      }))
                    }
                    onClick={e => e.stopPropagation()}
                    onMouseDown={e => e.stopPropagation()}
                    onDragStart={e => e.preventDefault()}
                    className="w-16 h-1 bg-gray-200 rounded-lg appearance-none cursor-pointer"
                  />
                  <span className="text-sm text-gray-600 w-6 text-center">{editMarkerData.size}</span>
                </div>
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏µ:</label>
                <div className="flex items-center justify-center space-x-4">
                  {colorOptions.map(color => (
                    <button
                      key={color.value}
                      type="button"
                      onClick={() => setEditMarkerData({ ...editMarkerData, color: color.value })}
                      className={`w-6 h-6 rounded-full transition-all duration-200 shadow-md hover:shadow-lg ${color.bg} 
                        ${
                          editMarkerData.color === color.value
                            ? "ring-2 ring-offset-2 ring-gray-400 scale-125"
                            : "hover:scale-110"
                        }`}
                      title={color.label}
                    />
                  ))}
                </div>
              </div>

              <div className="flex justify-center space-x-3 pt-1">
                <button
                  type="submit"
                  className="w-12 h-12 bg-blue-500 text-white rounded-full hover:bg-blue-600 transition-all duration-200 cursor-pointer flex items-center justify-center shadow-md hover:shadow-lg relative overflow-hidden group"
                  title="‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç"
                >
                  <div className="absolute inset-0 flex flex-col items-center justify-center transition-transform duration-300 group-hover:-translate-y-12">
                    <span className="text-lg">üíæ</span>
                  </div>
                  <div className="absolute inset-0 flex flex-col items-center justify-center transition-transform duration-300 translate-y-12 group-hover:translate-y-0">
                    <span className="text-xs font-medium">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</span>
                  </div>
                </button>
                <button
                  type="button"
                  onClick={() => {
                    // ‡∏Å‡∏•‡∏±‡∏ö‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏°
                    if (originalMarkerData) {
                      setMarkerSizes(prev => ({
                        ...prev,
                        [originalMarkerData.id]: originalMarkerData.size
                      }));
                    }
                    setShowEditMarkerModal(false);
                    setEditMarkerData(null);
                    setOriginalMarkerData(null);
                  }}
                  className="w-12 h-12 bg-gray-500 text-white rounded-full hover:bg-gray-600 transition-all duration-200 cursor-pointer flex items-center justify-center shadow-md hover:shadow-lg relative overflow-hidden group"
                  title="‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç"
                >
                  <div className="absolute inset-0 flex flex-col items-center justify-center transition-transform duration-300 group-hover:-translate-y-12">
                    <span className="text-lg">‚úï</span>
                  </div>
                  <div className="absolute inset-0 flex flex-col items-center justify-center transition-transform duration-300 translate-y-12 group-hover:translate-y-0">
                    <span className="text-xs font-medium">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</span>
                  </div>
                </button>
                <button
                  type="button"
                  onClick={() => {
                    resetMarkerPosition(editMarkerData.id);
                    setShowEditMarkerModal(false);
                    setEditMarkerData(null);
                    setOriginalMarkerData(null);
                  }}
                  className="w-12 h-12 bg-yellow-500 text-white rounded-full hover:bg-yellow-600 transition-all duration-200 cursor-pointer flex items-center justify-center shadow-md hover:shadow-lg relative overflow-hidden group"
                  title="‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÄ‡∏î‡∏¥‡∏°"
                >
                  <div className="absolute inset-0 flex flex-col items-center justify-center transition-transform duration-300 group-hover:-translate-y-12">
                    <span className="text-lg">‚Ü∫</span>
                  </div>
                  <div className="absolute inset-0 flex flex-col items-center justify-center transition-transform duration-300 translate-y-12 group-hover:translate-y-0">
                    <span className="text-xs font-medium">‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï</span>
                  </div>
                </button>
                <button
                  type="button"
                  onClick={() => {
                    removeMarker(editMarkerData.id);
                    setShowEditMarkerModal(false);
                    setEditMarkerData(null);
                    setOriginalMarkerData(null);
                  }}
                  className="w-12 h-12 bg-red-500 text-white rounded-full hover:bg-red-600 transition-all duration-200 cursor-pointer flex items-center justify-center shadow-md hover:shadow-lg relative overflow-hidden group"
                  title="‡∏•‡∏ö marker ‡∏ô‡∏µ‡πâ"
                >
                  <div className="absolute inset-0 flex flex-col items-center justify-center transition-transform duration-300 group-hover:-translate-y-12">
                    <span className="text-lg">üóëÔ∏è</span>
                  </div>
                  <div className="absolute inset-0 flex flex-col items-center justify-center transition-transform duration-300 translate-y-12 group-hover:translate-y-0">
                    <span className="text-xs font-medium">‡∏•‡∏ö</span>
                  </div>
                </button>
              </div>
            </form>
          </div>
        </div>
      )}

      {/* Popup Form ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Å‡∏•‡∏∏‡πà‡∏° */}
      {showEditZoneModal && editZoneData && (
        <div
          className="fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 
            bg-white rounded-lg shadow-xl border border-gray-200 p-4 z-50 w-72"
        >
          <div className="relative">
            <form onSubmit={handleEditZoneSubmit} className="space-y-3">
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏•‡∏∏‡πà‡∏°:</label>
                <input
                  type="text"
                  value={editZoneData.name}
                  onChange={e => setEditZoneData({ ...editZoneData, name: e.target.value })}
                  className="w-full px-3 py-1.5 text-sm border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200"
                  placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ö‡∏£‡∏¥‡πÄ‡∏ß‡∏ì‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô"
                  autoFocus
                  required
                />
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">‡∏£‡∏π‡∏õ‡∏ó‡∏£‡∏á:</label>
                <div className="flex space-x-2">
                  {zoneShapeOptions.map(shape => (
                    <button
                      key={shape.value}
                      type="button"
                      onClick={() => setEditZoneData({ ...editZoneData, shape: shape.value })}
                      className={`flex-1 py-1.5 px-2 text-xs rounded border transition-all duration-200 ${
                        (editZoneData.shape || "rectangle") === shape.value
                          ? "bg-blue-500 text-white border-blue-500"
                          : "bg-white text-gray-700 border-gray-300 hover:border-blue-300"
                      }`}
                    >
                      {shape.icon} {shape.label}
                    </button>
                  ))}
                </div>
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏µ‡∏Å‡∏•‡∏∏‡πà‡∏°:</label>
                <div className="flex items-center justify-center space-x-4">
                  {zoneColorOptions.map(color => (
                    <button
                      key={color.value}
                      type="button"
                      onClick={() => setEditZoneData({ ...editZoneData, color: color.value })}
                      className={`w-6 h-6 rounded-full transition-all duration-200 shadow-md hover:shadow-lg ${color.bg} 
                        ${
                          editZoneData.color === color.value
                            ? "ring-2 ring-offset-2 ring-gray-400 scale-125"
                            : "hover:scale-110"
                        }`}
                      title={color.label}
                    />
                  ))}
                </div>
              </div>

              <div className="flex justify-center space-x-3 pt-1">
                <button
                  type="submit"
                  className="w-12 h-12 bg-blue-500 text-white rounded-full hover:bg-blue-600 transition-all duration-200 cursor-pointer flex items-center justify-center shadow-md hover:shadow-lg relative overflow-hidden group"
                  title="‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç"
                >
                  <div className="absolute inset-0 flex flex-col items-center justify-center transition-transform duration-300 group-hover:-translate-y-12">
                    <span className="text-lg">üíæ</span>
                  </div>
                  <div className="absolute inset-0 flex flex-col items-center justify-center transition-transform duration-300 translate-y-12 group-hover:translate-y-0">
                    <span className="text-xs font-medium">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</span>
                  </div>
                </button>
                <button
                  type="button"
                  onClick={() => {
                    // ‡∏Å‡∏•‡∏±‡∏ö‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏°
                    if (originalZoneData) {
                      setEditZoneData({ ...originalZoneData });
                    }
                    setShowEditZoneModal(false);
                    setEditZoneData(null);
                    setOriginalZoneData(null);
                  }}
                  className="w-12 h-12 bg-gray-500 text-white rounded-full hover:bg-gray-600 transition-all duration-200 cursor-pointer flex items-center justify-center shadow-md hover:shadow-lg relative overflow-hidden group"
                  title="‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç"
                >
                  <div className="absolute inset-0 flex flex-col items-center justify-center transition-transform duration-300 group-hover:-translate-y-12">
                    <span className="text-lg">‚úï</span>
                  </div>
                  <div className="absolute inset-0 flex flex-col items-center justify-center transition-transform duration-300 translate-y-12 group-hover:translate-y-0">
                    <span className="text-xs font-medium">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</span>
                  </div>
                </button>
                <button
                  type="button"
                  onClick={() => {
                    resetZonePosition(editZoneData.id);
                    setShowEditZoneModal(false);
                    setEditZoneData(null);
                    setOriginalZoneData(null);
                  }}
                  className="w-12 h-12 bg-yellow-500 text-white rounded-full hover:bg-yellow-600 transition-all duration-200 cursor-pointer flex items-center justify-center shadow-md hover:shadow-lg relative overflow-hidden group"
                  title="‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÄ‡∏î‡∏¥‡∏°"
                >
                  <div className="absolute inset-0 flex flex-col items-center justify-center transition-transform duration-300 group-hover:-translate-y-12">
                    <span className="text-lg">‚Ü∫</span>
                  </div>
                  <div className="absolute inset-0 flex flex-col items-center justify-center transition-transform duration-300 translate-y-12 group-hover:translate-y-0">
                    <span className="text-xs font-medium">‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï</span>
                  </div>
                </button>
                <button
                  type="button"
                  onClick={() => {
                    removeZone(editZoneData.id);
                    setShowEditZoneModal(false);
                    setEditZoneData(null);
                    setOriginalZoneData(null);
                  }}
                  className="w-12 h-12 bg-red-500 text-white rounded-full hover:bg-red-600 transition-all duration-200 cursor-pointer flex items-center justify-center shadow-md hover:shadow-lg relative overflow-hidden group"
                  title="‡∏•‡∏ö‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ô‡∏µ‡πâ"
                >
                  <div className="absolute inset-0 flex flex-col items-center justify-center transition-transform duration-300 group-hover:-translate-y-12">
                    <span className="text-lg">üóëÔ∏è</span>
                  </div>
                  <div className="absolute inset-0 flex flex-col items-center justify-center transition-transform duration-300 translate-y-12 group-hover:translate-y-0">
                    <span className="text-xs font-medium">‡∏•‡∏ö</span>
                  </div>
                </button>
              </div>
            </form>
          </div>
        </div>
      )}

      {/* Custom CSS for animations */}
      <style jsx>{`
        @keyframes scaleIn {
          from {
            opacity: 0;
            transform: translate(-50%, 20px) scale(0.95);
          }
          to {
            opacity: 1;
            transform: translate(-50%, 0) scale(1);
          }
        }

        .animate-scaleIn {
          animation: scaleIn 0.2s ease-out forwards;
        }

        @keyframes fadeIn {
          from {
            opacity: 0;
          }
          to {
            opacity: 1;
          }
        }

        .fade-in {
          animation: fadeIn 0.3s ease-out forwards;
        }

        /* Custom Range Slider Styles */
        input[type="range"] {
          -webkit-appearance: none;
          appearance: none;
          height: 4px;
          border-radius: 2px;
          background: #e5e7eb;
          outline: none;
          transition: all 0.2s;
        }

        input[type="range"]::-webkit-slider-thumb {
          -webkit-appearance: none;
          appearance: none;
          width: 12px;
          height: 12px;
          border-radius: 50%;
          background: #3b82f6;
          cursor: pointer;
          transition: all 0.2s;
        }

        input[type="range"]::-moz-range-thumb {
          width: 12px;
          height: 12px;
          border-radius: 50%;
          background: #3b82f6;
          cursor: pointer;
          transition: all 0.2s;
          border: none;
        }

        input[type="range"]:hover::-webkit-slider-thumb {
          background: #2563eb;
          transform: scale(1.2);
        }

        input[type="range"]:hover::-moz-range-thumb {
          background: #2563eb;
          transform: scale(1.2);
        }

        input[type="range"]:active::-webkit-slider-thumb {
          transform: scale(1.1);
        }

        input[type="range"]:active::-moz-range-thumb {
          transform: scale(1.1);
        }
      `}</style>
    </div>
  );
}
