"use client";

import { useEffect, useRef, useState } from "react";

const VoiceControl = ({ onCommand }) => {
  const [isSupported, setIsSupported] = useState(false);
  const [isListening, setIsListening] = useState(false);
  const [transcript, setTranscript] = useState("");
  const recognitionRef = useRef(null);
  const silenceTimerRef = useRef(null);
  const [isRecording, setIsRecording] = useState(false);
  const [lastCommand, setLastCommand] = useState("");
  const [commandResult, setCommandResult] = useState("");

  useEffect(() => {
    // р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕Бр╕▓р╕гр╕гр╕нр╕Зр╕гр╕▒р╕Ъ Speech Recognition
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

    if (SpeechRecognition) {
      setIsSupported(true);
      const recognition = new SpeechRecognition();

      // р╕Хр╕▒р╣Йр╕Зр╕Др╣Ир╕▓ recognition
      recognition.continuous = false; // р╣Др╕бр╣Ир╕Яр╕▒р╕Зр╕Хр╣Ир╕нр╣Ар╕Щр╕╖р╣Ир╕нр╕З
      recognition.interimResults = true; // р╣Бр╕кр╕Фр╕Зр╕Ьр╕ер╕гр╕░р╕лр╕зр╣Ир╕▓р╕Зр╕Яр╕▒р╕З
      recognition.lang = "th-TH"; // р╕ар╕▓р╕йр╕▓р╣Др╕Чр╕вр╣Ар╕Ыр╣Зр╕Щр╕лр╕ер╕▒р╕Б

      // р╕Ир╕▒р╕Фр╕Бр╕▓р╕гр╣Ар╕бр╕╖р╣Ир╕нр╣Др╕Фр╣Йр╕Ьр╕ер╕ер╕▒р╕Юр╕Шр╣М
      recognition.onresult = event => {
        console.log("ЁЯОд р╣Др╕Фр╣Йр╕гр╕▒р╕Ър╕Ьр╕ер╕ер╕▒р╕Юр╕Шр╣М (onresult):", event);

        let currentTranscript = "";

        for (let i = event.resultIndex; i < event.results.length; i++) {
          const result = event.results[i];
          console.log(`ЁЯОд р╕Ьр╕ер╕ер╕▒р╕Юр╕Шр╣М ${i}:`, result[0].transcript, `(confidence: ${result[0].confidence})`);

          if (result.isFinal) {
            console.log("ЁЯОд тЬЕ р╕Ьр╕ер╕ер╕▒р╕Юр╕Шр╣Мр╕кр╕╕р╕Фр╕Чр╣Йр╕▓р╕в:", result[0].transcript);
            currentTranscript += result[0].transcript;
          } else {
            console.log("ЁЯОд тП│ р╕Ьр╕ер╕ер╕▒р╕Юр╕Шр╣Мр╕Кр╕▒р╣Ир╕зр╕Др╕гр╕▓р╕з:", result[0].transcript);
            currentTranscript += result[0].transcript;
          }
        }

        if (currentTranscript.trim()) {
          console.log("ЁЯОд transcript р╕гр╕зр╕б:", currentTranscript);
          setTranscript(currentTranscript);

          // р╣Гр╕кр╣И timeout р╣Ар╕Юр╕╖р╣Ир╕нр╣Гр╕лр╣Й user р╣Ар╕лр╣Зр╕Щр╕Др╕│р╕Чр╕╡р╣Ир╣Др╕Фр╣Йр╕вр╕┤р╕Щ
          clearTimeout(silenceTimerRef.current);
          silenceTimerRef.current = setTimeout(() => {
            console.log("ЁЯОд тП░ Timeout - р╕Ыр╕гр╕░р╕бр╕зр╕ер╕Ьр╕ер╕Др╕│р╕кр╕▒р╣Ир╕З");
            processVoiceCommand(currentTranscript);
            setIsListening(false);
          }, 500); // р╕лр╕вр╕╕р╕Фр╕Юр╕╣р╕Ф 0.5 р╕зр╕┤
        }
      };

      // р╕Ир╕▒р╕Фр╕Бр╕▓р╕гр╣Ар╕бр╕╖р╣Ир╕нр╣Ар╕гр╕┤р╣Ир╕бр╕Яр╕▒р╕З
      recognition.onstart = () => {
        console.log("ЁЯОд тЬЕ р╣Ар╕гр╕┤р╣Ир╕бр╕Яр╕▒р╕Зр╣Ар╕кр╕╡р╕вр╕Зр╣Бр╕ер╣Йр╕з (onstart)");
        setIsListening(true);
        setTranscript("");
        setCommandResult(""); // р╕ер╣Йр╕▓р╕Зр╕Ьр╕ер╕ер╕▒р╕Юр╕Шр╣Мр╣Ар╕Бр╣Ир╕▓
        setLastCommand(""); // р╕ер╣Йр╕▓р╕Зр╕Др╕│р╕кр╕▒р╣Ир╕Зр╣Ар╕Бр╣Ир╕▓
      };

      // р╕Ир╕▒р╕Фр╕Бр╕▓р╕гр╕Ьр╕ер╕ер╕▒р╕Юр╕Шр╣Мр╕Бр╕▓р╕гр╕гр╕▒р╕Ър╕гр╕╣р╣Йр╣Ар╕кр╕╡р╕вр╕З
      recognition.onresult = event => {
        console.log("ЁЯОд р╣Др╕Фр╣Йр╕Ьр╕ер╕ер╕▒р╕Юр╕Шр╣М:", event);

        let finalTranscript = "";
        let interimTranscript = "";

        // р╕гр╕зр╕Ър╕гр╕зр╕б transcript
        for (let i = 0; i < event.results.length; i++) {
          const transcript = event.results[i][0].transcript;
          if (event.results[i].isFinal) {
            finalTranscript += transcript;
          } else {
            interimTranscript += transcript;
          }
        }

        const fullTranscript = finalTranscript + interimTranscript;
        console.log("ЁЯОд transcript р╕гр╕зр╕б:", fullTranscript);
        setTranscript(fullTranscript);

        // р╕Цр╣Йр╕▓р╣Др╕Фр╣Йр╕Др╕│р╕Юр╕╣р╕Фр╕кр╕╕р╕Фр╕Чр╣Йр╕▓р╕в р╣Гр╕лр╣Йр╕Ыр╕гр╕░р╕бр╕зр╕ер╕Ьр╕ер╕Др╕│р╕кр╕▒р╣Ир╕З
        if (finalTranscript.trim()) {
          console.log("ЁЯОд р╕Ыр╕гр╕░р╕бр╕зр╕ер╕Ьр╕ер╕Др╕│р╕кр╕▒р╣Ир╕Зр╣Ар╕кр╕╡р╕вр╕З:", finalTranscript);
          processVoiceCommand(finalTranscript.trim());
        }
      };

      // р╕Ир╕▒р╕Фр╕Бр╕▓р╕гр╣Ар╕бр╕╖р╣Ир╕нр╕лр╕вр╕╕р╕Фр╕Яр╕▒р╕З
      recognition.onend = () => {
        console.log("ЁЯОд р╕лр╕вр╕╕р╕Фр╕Яр╕▒р╕З");
        setIsListening(false);
        setIsRecording(false);

        // р╕ер╣Йр╕▓р╕З timer
        if (silenceTimerRef.current) {
          clearTimeout(silenceTimerRef.current);
          silenceTimerRef.current = null;
        }
      };

      // р╕Ир╕▒р╕Фр╕Бр╕▓р╕гр╕Вр╣Йр╕нр╕Ьр╕┤р╕Фр╕Юр╕ер╕▓р╕Ф
      recognition.onerror = event => {
        console.log("ЁЯОд р╕Вр╣Йр╕нр╕Ьр╕┤р╕Фр╕Юр╕ер╕▓р╕Ф:", event.error);

        if (event.error === "not-allowed") {
          console.log("ЁЯОд р╣Др╕бр╣Ир╣Др╕Фр╣Йр╕гр╕▒р╕Ър╕нр╕Щр╕╕р╕Нр╕▓р╕Хр╣Гр╕лр╣Йр╣Гр╕Кр╣Йр╣Др╕бр╣Вр╕Др╕гр╣Вр╕Яр╕Щ");
        } else if (event.error === "no-speech") {
          console.log("ЁЯОд р╣Др╕бр╣Ир╕бр╕╡р╣Ар╕кр╕╡р╕вр╕Зр╕Юр╕╣р╕Ф - р╕лр╕вр╕╕р╕Фр╕Яр╕▒р╕З");
        } else {
          console.log("ЁЯОд р╣Ар╕Бр╕┤р╕Фр╕Вр╣Йр╕нр╕Ьр╕┤р╕Фр╕Юр╕ер╕▓р╕Ф - р╕лр╕вр╕╕р╕Фр╕Яр╕▒р╕З");
        }

        setIsListening(false);
        setIsRecording(false);
      };

      recognitionRef.current = recognition;
    } else {
      console.log("ЁЯОд р╣Ар╕Ър╕гр╕▓р╕зр╣Мр╣Ар╕Лр╕нр╕гр╣Мр╣Др╕бр╣Ир╕гр╕нр╕Зр╕гр╕▒р╕Ъ Speech Recognition");
      setIsSupported(false);
    }

    // Cleanup
    return () => {
      if (silenceTimerRef.current) {
        clearTimeout(silenceTimerRef.current);
      }
    };
  }, []);

  // р╣Ар╕Юр╕┤р╣Ир╕б useEffect р╣Ар╕Юр╕╖р╣Ир╕нр╕ер╣Йр╕▓р╕Зр╕Ьр╕ер╕ер╕▒р╕Юр╕Шр╣Мр╕Др╕│р╕кр╕▒р╣Ир╕Зр╕лр╕ер╕▒р╕Зр╕Ир╕▓р╕Б 3 р╕зр╕┤р╕Щр╕▓р╕Чр╕╡
  useEffect(
    () => {
      if (commandResult) {
        const timer = setTimeout(() => {
          setCommandResult("");
          setLastCommand("");
        }, 3000); // р╕ер╣Йр╕▓р╕Зр╕лр╕ер╕▒р╕Зр╕Ир╕▓р╕Б 3 р╕зр╕┤р╕Щр╕▓р╕Чр╕╡

        return () => clearTimeout(timer);
      }
    },
    [commandResult]
  );

  // р╕Яр╕▒р╕Зр╕Бр╣Мр╕Кр╕▒р╕Щр╣Ар╕гр╕┤р╣Ир╕бр╕Яр╕▒р╕З
  const startListening = async () => {
    console.log("ЁЯОд startListening() р╕Цр╕╣р╕Бр╣Ар╕гр╕╡р╕вр╕Б");

    if (!recognitionRef.current) {
      console.log("ЁЯОд тЭМ recognitionRef.current р╣Др╕бр╣Ир╕бр╕╡");
      return;
    }

    if (isListening) {
      console.log("ЁЯОд тЭМ р╕Бр╕│р╕ер╕▒р╕Зр╕Яр╕▒р╕Зр╕нр╕вр╕╣р╣Ир╣Бр╕ер╣Йр╕з");
      return;
    }

    try {
      console.log("ЁЯОд р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕кр╕┤р╕Чр╕Шр╕┤р╣Мр╣Др╕бр╣Вр╕Др╕гр╣Вр╕Яр╕Щ...");

      // р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕кр╕┤р╕Чр╕Шр╕┤р╣Мр╣Др╕бр╣Вр╕Др╕гр╣Вр╕Яр╕Щ
      const permission = await navigator.permissions.query({ name: "microphone" });
      console.log("ЁЯОд р╕кр╕┤р╕Чр╕Шр╕┤р╣Мр╣Др╕бр╣Вр╕Др╕гр╣Вр╕Яр╕Щ:", permission.state);

      if (permission.state === "denied") {
        console.log("ЁЯОд тЭМ р╣Др╕бр╣Вр╕Др╕гр╣Вр╕Яр╕Щр╕Цр╕╣р╕Бр╕Ыр╕Пр╕┤р╣Ар╕кр╕Ш");
        return;
      }

      console.log("ЁЯОд р╕Чр╕Фр╕кр╕нр╕Ър╕Бр╕▓р╕гр╣Ар╕Вр╣Йр╕▓р╕Цр╕╢р╕Зр╣Др╕бр╣Вр╕Др╕гр╣Вр╕Яр╕Щ...");

      // р╕Чр╕Фр╕кр╕нр╕Ър╕Бр╕▓р╕гр╣Ар╕Вр╣Йр╕▓р╕Цр╕╢р╕Зр╣Др╕бр╣Вр╕Др╕гр╣Вр╕Яр╕Щ
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      stream.getTracks().forEach(track => track.stop()); // р╕лр╕вр╕╕р╕Фр╕Чр╕▒р╕Щр╕Чр╕╡

      console.log("ЁЯОд тЬЕ р╣Ар╕гр╕┤р╣Ир╕бр╕Яр╕▒р╕З...");
      recognitionRef.current.start();
    } catch (error) {
      console.log("ЁЯОд тЭМ р╣Др╕бр╣Ир╕кр╕▓р╕бр╕▓р╕гр╕Цр╣Ар╕Вр╣Йр╕▓р╕Цр╕╢р╕Зр╣Др╕бр╣Вр╕Др╕гр╣Вр╕Яр╕Щр╣Др╕Фр╣Й:", error.message);
      if (error.name === "NotAllowedError") {
        console.log("ЁЯОд тЭМ р╕Бр╕гр╕╕р╕Ур╕▓р╕нр╕Щр╕╕р╕Нр╕▓р╕Хр╕Бр╕▓р╕гр╣Гр╕Кр╣Йр╣Др╕бр╣Вр╕Др╕гр╣Вр╕Яр╕Щр╣Гр╕Щр╣Ар╕Ър╕гр╕▓р╕зр╣Мр╣Ар╕Лр╕нр╕гр╣М");
      }
    }
  };

  // р╕Яр╕▒р╕Зр╕Бр╣Мр╕Кр╕▒р╕Щр╕лр╕вр╕╕р╕Фр╕Яр╕▒р╕З
  const stopListening = () => {
    console.log("ЁЯОд stopListening() р╕Цр╕╣р╕Бр╣Ар╕гр╕╡р╕вр╕Б");

    if (!isListening) {
      console.log("ЁЯОд р╣Др╕бр╣Ир╣Др╕Фр╣Йр╕Яр╕▒р╕Зр╕нр╕вр╕╣р╣И");
      return;
    }

    console.log("ЁЯОд тЬЕ р╕лр╕вр╕╕р╕Фр╕Яр╕▒р╕З");
    recognitionRef.current?.stop();
  };

  // р╕Ыр╕гр╕░р╕бр╕зр╕ер╕Ьр╕ер╕Др╕│р╕кр╕▒р╣Ир╕Зр╣Ар╕кр╕╡р╕вр╕З
  const processVoiceCommand = command => {
    const cmd = command.toLowerCase().trim();
    console.log("ЁЯФД р╕Ыр╕гр╕░р╕бр╕зр╕ер╕Ьр╕ер╕Др╕│р╕кр╕▒р╣Ир╕З:", cmd);
    console.log("ЁЯФД р╕Др╕│р╕кр╕▒р╣Ир╕Зр╣Ар╕Фр╕┤р╕б (р╕Бр╣Ир╕нр╕Щ toLowerCase):", command);
    console.log("ЁЯФД р╕Чр╕Фр╕кр╕нр╕Ъ: cmd.includes('р╕гр╕╡р╣Ар╕Лр╣Зр╕Хр╕бр╕▓р╕гр╣Мр╕Др╣Ар╕Бр╕нр╕гр╣М'):", cmd.includes("р╕гр╕╡р╣Ар╕Лр╣Зр╕Хр╕бр╕▓р╕гр╣Мр╕Др╣Ар╕Бр╕нр╕гр╣М"));
    console.log("ЁЯФД р╕Чр╕Фр╕кр╕нр╕Ъ: cmd.includes('р╕гр╕╡р╣Ар╕Лр╣Зр╕Х marker'):", cmd.includes("р╕гр╕╡р╣Ар╕Лр╣Зр╕Х marker"));

    // р╣Ар╕Бр╣Зр╕Ър╕Др╕│р╕кр╕▒р╣Ир╕Зр╕ер╣Ир╕▓р╕кр╕╕р╕Ф
    setLastCommand(command);

    // р╕Др╕│р╕кр╕▒р╣Ир╕Зр╕гр╕╡р╣Ар╕Лр╣Зр╕Хр╕Чр╕╕р╕Бр╕нр╕вр╣Ир╕▓р╕З (р╣Др╕Чр╕в + р╕нр╕▒р╕Зр╕Бр╕др╕й) - р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕Бр╣Ир╕нр╕Щ
    if (
      cmd.includes("reset all") ||
      cmd.includes("reset everything") ||
      cmd.includes("clear all") ||
      cmd.includes("р╕гр╕╡р╣Ар╕Лр╣Зр╕Хр╕Чр╕▒р╣Йр╕Зр╕лр╕бр╕Ф") ||
      cmd.includes("р╕гр╕╡р╣Ар╕Лр╣Зр╕Чр╕Чр╕▒р╣Йр╕Зр╕лр╕бр╕Ф") ||
      cmd.includes("р╕ер╕Ър╕Чр╕▒р╣Йр╕Зр╕лр╕бр╕Ф") ||
      cmd.includes("р╕ер╣Йр╕▓р╕Зр╕Чр╕▒р╣Йр╕Зр╕лр╕бр╕Ф") ||
      cmd.includes("р╣Ар╕Др╕ер╕╡р╕вр╕гр╣Мр╕Чр╕▒р╣Йр╕Зр╕лр╕бр╕Ф")
    ) {
      console.log("ЁЯФД Voice Command: Reset Everything");
      console.log("ЁЯФД р╕кр╣Ир╕Зр╕Др╕│р╕кр╕▒р╣Ир╕З RESET_EVERYTHING р╣Др╕Ыр╕вр╕▒р╕З handleVoiceCommand");
      console.log("ЁЯФД onCommand function type:", typeof onCommand);
      console.log("ЁЯФД р╣Ар╕гр╕╡р╕вр╕Б onCommand('RESET_EVERYTHING')...");
      setCommandResult("тЬЕ р╕гр╕╡р╣Ар╕Лр╣Зр╕Хр╕Чр╕╕р╕Бр╕нр╕вр╣Ир╕▓р╕Зр╣Бр╕ер╣Йр╕з");
      onCommand("RESET_EVERYTHING");
      console.log("ЁЯФД тЬЕ р╣Ар╕гр╕╡р╕вр╕Б onCommand р╣Ар╕кр╕гр╣Зр╕Ир╣Бр╕ер╣Йр╕з");
      return;
    }

    // р╕Др╕│р╕кр╕▒р╣Ир╕Зр╕гр╕╡р╣Ар╕Лр╣Зр╕Х markers (р╣Др╕Чр╕в + р╕нр╕▒р╕Зр╕Бр╕др╕й) - р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕Бр╣Ир╕нр╕Щр╕Др╕│р╕кр╕▒р╣Ир╕Зр╕Чр╕▒р╣Ир╕зр╣Др╕Ы
    if (
      cmd.includes("reset marker") ||
      cmd.includes("reset markers") ||
      cmd.includes("reset maker") ||
      cmd.includes("reset parker") ||
      cmd.includes("clear marker") ||
      cmd.includes("clear markers") ||
      cmd.includes("delete marker") ||
      cmd.includes("delete markers") ||
      cmd.includes("remove marker") ||
      cmd.includes("remove markers") ||
      cmd.includes("р╕гр╕╡р╣Ар╕Лр╣Зр╕Хр╕бр╕▓р╕гр╣Мр╕Бр╣Ар╕Бр╕нр╕гр╣М") ||
      cmd.includes("р╕гр╕╡р╣Ар╕Лр╣Зр╕Чр╕бр╕▓р╕гр╣Мр╕Бр╣Ар╕Бр╕нр╕гр╣М") ||
      cmd.includes("р╕гр╕╡р╣Ар╕Лр╣Зр╕Хр╕бр╕▓р╕гр╣Мр╕Др╣Ар╕Бр╕нр╕гр╣М") ||
      cmd.includes("р╕гр╕╡р╣Ар╕Лр╣Зр╕Чр╕бр╕▓р╕гр╣Мр╕Др╣Ар╕Бр╕нр╕гр╣М") ||
      cmd.includes("р╕гр╕╡р╣Ар╕Лр╣Зр╕Х marker") ||
      cmd.includes("р╕гр╕╡р╣Ар╕Лр╣Зр╕Ч marker") ||
      cmd.includes("р╕ер╕Ър╕бр╕▓р╕гр╣Мр╕Бр╣Ар╕Бр╕нр╕гр╣М") ||
      cmd.includes("р╕ер╕Ър╕бр╕▓р╕гр╣Мр╕Бр╣Ар╕Бр╕нр╕гр╣Мр╕Чр╕▒р╣Йр╕Зр╕лр╕бр╕Ф") ||
      cmd.includes("р╕ер╣Йр╕▓р╕Зр╕бр╕▓р╕гр╣Мр╕Бр╣Ар╕Бр╕нр╕гр╣М") ||
      cmd.includes("р╣Ар╕Др╕ер╕╡р╕вр╕гр╣Мр╕бр╕▓р╕гр╣Мр╕Бр╣Ар╕Бр╕нр╕гр╣М") ||
      cmd.includes("р╕ер╕Ър╕Ир╕╕р╕Ф") ||
      cmd.includes("р╕ер╕Ър╕Ир╕╕р╕Фр╕Чр╕▒р╣Йр╕Зр╕лр╕бр╕Ф") ||
      cmd.includes("р╕ер╕Ър╕Ир╕╕р╕Фр╕лр╕бр╕Ф") ||
      cmd.includes("р╕гр╕╡р╣Ар╕Лр╣Зр╕Хр╕Ир╕╕р╕Ф") ||
      cmd.includes("р╕гр╕╡р╣Ар╕Лр╣Зр╕Чр╕Ир╕╕р╕Ф")
    ) {
      console.log("ЁЯФД Voice Command: Reset All Markers");
      console.log("ЁЯФД р╕кр╣Ир╕Зр╕Др╕│р╕кр╕▒р╣Ир╕З RESET_ALL_MARKERS р╣Др╕Ыр╕вр╕▒р╕З handleVoiceCommand");
      setCommandResult("тЬЕ р╕гр╕╡р╣Ар╕Лр╣Зр╕Хр╕бр╕▓р╕гр╣Мр╕Бр╣Ар╕Бр╕нр╕гр╣Мр╣Бр╕ер╣Йр╕з");
      onCommand("RESET_ALL_MARKERS");
      return;
    }

    // р╕Др╕│р╕кр╕▒р╣Ир╕Зр╕гр╕╡р╣Ар╕Лр╣Зр╕Х zones/groups (р╣Др╕Чр╕в + р╕нр╕▒р╕Зр╕Бр╕др╕й) - р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕Бр╣Ир╕нр╕Щр╕Др╕│р╕кр╕▒р╣Ир╕Зр╕Чр╕▒р╣Ир╕зр╣Др╕Ы
    if (
      cmd.includes("reset zone") ||
      cmd.includes("reset zones") ||
      cmd.includes("reset group") ||
      cmd.includes("reset groups") ||
      cmd.includes("clear zone") ||
      cmd.includes("clear zones") ||
      cmd.includes("clear group") ||
      cmd.includes("clear groups") ||
      cmd.includes("delete zone") ||
      cmd.includes("delete zones") ||
      cmd.includes("delete group") ||
      cmd.includes("delete groups") ||
      cmd.includes("remove zone") ||
      cmd.includes("remove zones") ||
      cmd.includes("remove group") ||
      cmd.includes("remove groups") ||
      cmd.includes("р╕гр╕╡р╣Ар╕Лр╣Зр╕Хр╣Вр╕Лр╕Щ") ||
      cmd.includes("р╕гр╕╡р╣Ар╕Лр╣Зр╕Чр╣Вр╕Лр╕Щ") ||
      cmd.includes("р╕ер╕Ър╣Вр╕Лр╕Щ") ||
      cmd.includes("р╕ер╕Ър╣Вр╕Лр╕Щр╕Чр╕▒р╣Йр╕Зр╕лр╕бр╕Ф") ||
      cmd.includes("р╕ер╣Йр╕▓р╕Зр╣Вр╕Лр╕Щ") ||
      cmd.includes("р╣Ар╕Др╕ер╕╡р╕вр╕гр╣Мр╣Вр╕Лр╕Щ") ||
      cmd.includes("р╕гр╕╡р╣Ар╕Лр╣Зр╕Хр╕Бр╕ер╕╕р╣Ир╕б") ||
      cmd.includes("р╕гр╕╡р╣Ар╕Лр╣Зр╕Чр╕Бр╕ер╕╕р╣Ир╕б") ||
      cmd.includes("р╕ер╕Ър╕Бр╕ер╕╕р╣Ир╕б") ||
      cmd.includes("р╕ер╕Ър╕Бр╕ер╕╕р╣Ир╕бр╕Чр╕▒р╣Йр╕Зр╕лр╕бр╕Ф") ||
      cmd.includes("р╕ер╕Ър╕Юр╕╖р╣Йр╕Щр╕Чр╕╡р╣И") ||
      cmd.includes("р╕ер╕Ър╕Юр╕╖р╣Йр╕Щр╕Чр╕╡р╣Ир╕Чр╕▒р╣Йр╕Зр╕лр╕бр╕Ф") ||
      cmd.includes("р╕ер╕Ър╕Юр╕╖р╣Йр╕Щр╕Чр╕╡р╣Ир╕лр╕бр╕Ф") ||
      cmd.includes("р╕ер╕Ър╕Бр╕гр╕╕р╣Кр╕Ы") ||
      cmd.includes("р╕ер╕Ър╕Бр╕гр╕╕р╣Кр╕Ыр╕Чр╕▒р╣Йр╕Зр╕лр╕бр╕Ф") ||
      cmd.includes("р╕гр╕╡р╣Ар╕Лр╣Зр╕Хр╕Бр╕гр╕╕р╣Кр╕Ы") ||
      cmd.includes("р╕гр╕╡р╣Ар╕Лр╣Зр╕Чр╕Бр╕гр╕╕р╣Кр╕Ы")
    ) {
      console.log("ЁЯФД Voice Command: Reset All Zones/Groups");
      console.log("ЁЯФД р╕кр╣Ир╕Зр╕Др╕│р╕кр╕▒р╣Ир╕З RESET_ALL_ZONES р╣Др╕Ыр╕вр╕▒р╕З handleVoiceCommand");
      setCommandResult("тЬЕ р╕гр╕╡р╣Ар╕Лр╣Зр╕Хр╕Бр╕ер╕╕р╣Ир╕б/р╣Вр╕Лр╕Щр╣Бр╕ер╣Йр╕з");
      onCommand("RESET_ALL_ZONES");
      return;
    }

    // р╕Др╕│р╕кр╕▒р╣Ир╕Зр╕ер╕Ъ object р╕Чр╕╡р╣Ир╣Ар╕ер╕╖р╕нр╕Б (р╣Др╕Чр╕в + р╕нр╕▒р╕Зр╕Бр╕др╕й) - р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕лр╕ер╕▒р╕Зр╕Др╕│р╕кр╕▒р╣Ир╕Зр╣Ар╕Йр╕Юр╕▓р╕░
    if (
      cmd.includes("delete") ||
      cmd.includes("remove") ||
      cmd.includes("р╕ер╕Ъ") ||
      cmd.includes("р╣Ар╕нр╕▓р╕нр╕нр╕Б") ||
      cmd.includes("р╕ер╕Ър╕нр╕нр╕Б")
    ) {
      console.log("ЁЯЧСя╕П Voice Command: Delete Selected");
      console.log("ЁЯФД р╕кр╣Ир╕Зр╕Др╕│р╕кр╕▒р╣Ир╕З DELETE р╣Др╕Ыр╕вр╕▒р╕З handleVoiceCommand");
      setCommandResult("тЬЕ р╕ер╕Ър╣Бр╕ер╣Йр╕з");
      onCommand("DELETE");
      return;
    }

    // р╕Др╕│р╕кр╕▒р╣Ир╕З Undo (р╣Др╕Чр╕в + р╕нр╕▒р╕Зр╕Бр╕др╕й)
    if (
      cmd.includes("undo") ||
      cmd.includes("back") ||
      cmd.includes("р╕вр╣Йр╕нр╕Щр╕Бр╕ер╕▒р╕Ъ") ||
      cmd.includes("р╕вр╕Бр╣Ар╕ер╕┤р╕Б") ||
      cmd.includes("р╕Бр╕ер╕▒р╕Ъ") ||
      cmd.includes("р╕нр╕▒р╕Щр╕Фр╕╣")
    ) {
      console.log("тЖ╢ Voice Command: Undo");
      console.log("ЁЯФД р╕кр╣Ир╕Зр╕Др╕│р╕кр╕▒р╣Ир╕З UNDO р╣Др╕Ыр╕вр╕▒р╕З handleVoiceCommand");
      setCommandResult("тЬЕ р╕вр╣Йр╕нр╕Щр╕Бр╕ер╕▒р╕Ър╣Бр╕ер╣Йр╕з");
      onCommand("UNDO");
      return;
    }

    // р╕Др╕│р╕кр╕▒р╣Ир╕З Redo (р╣Др╕Чр╕в + р╕нр╕▒р╕Зр╕Бр╕др╕й)
    if (
      cmd.includes("redo") ||
      cmd.includes("next") ||
      cmd.includes("forward") ||
      cmd.includes("р╕Чр╕│р╕Лр╣Йр╕│") ||
      cmd.includes("р╕Чр╕│р╣Гр╕лр╕бр╣И") ||
      cmd.includes("р╕гр╕╡р╕Фр╕╣") ||
      cmd.includes("р╣Др╕Ыр╕Вр╣Йр╕▓р╕Зр╕лр╕Щр╣Йр╕▓")
    ) {
      console.log("тЖ╖ Voice Command: Redo");
      console.log("ЁЯФД р╕кр╣Ир╕Зр╕Др╕│р╕кр╕▒р╣Ир╕З REDO р╣Др╕Ыр╕вр╕▒р╕З handleVoiceCommand");
      setCommandResult("тЬЕ р╕Чр╕│р╕Лр╣Йр╕│р╣Бр╕ер╣Йр╕з");
      onCommand("REDO");
      return;
    }

    // р╕Др╕│р╕кр╕▒р╣Ир╕Зр╕гр╕╡р╣Ар╕Лр╣Зр╕Х (zoom/pan) (р╣Др╕Чр╕в + р╕нр╕▒р╕Зр╕Бр╕др╕й) - р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕лр╕ер╕▒р╕Зр╕кр╕╕р╕Ф
    if (
      cmd.includes("reset") ||
      cmd.includes("home") ||
      cmd.includes("center") ||
      cmd.includes("р╕гр╕╡р╣Ар╕Лр╣Зр╕Х") ||
      cmd.includes("р╕Бр╕ер╕▒р╕Ър╕лр╕Щр╣Йр╕▓р╣Бр╕гр╕Б") ||
      cmd.includes("р╕Бр╕╢р╣Ир╕Зр╕Бр╕ер╕▓р╕З") ||
      cmd.includes("р╕Хр╕гр╕Зр╕Бр╕ер╕▓р╕З") ||
      cmd.includes("р╕Бр╕ер╕▒р╕Ър╕Ыр╕Бр╕Хр╕┤")
    ) {
      console.log("ЁЯПа Voice Command: Reset View");
      console.log("ЁЯФД р╕кр╣Ир╕Зр╕Др╕│р╕кр╕▒р╣Ир╕З RESET р╣Др╕Ыр╕вр╕▒р╕З handleVoiceCommand");
      setCommandResult("тЬЕ р╕гр╕╡р╣Ар╕Лр╣Зр╕Хр╕бр╕╕р╕бр╕бр╕нр╕Зр╣Бр╕ер╣Йр╕з");
      onCommand("RESET");
      return;
    }

    // р╕Цр╣Йр╕▓р╣Др╕бр╣Ир╕Хр╕гр╕Зр╕Др╕│р╕кр╕▒р╣Ир╕Зр╣Гр╕Фр╣Ж
    console.log("тЭУ Unknown command:", command);
    console.log("ЁЯФД р╕кр╣Ир╕Зр╕Др╕│р╕кр╕▒р╣Ир╕З UNKNOWN р╣Др╕Ыр╕вр╕▒р╕З handleVoiceCommand");
    setCommandResult("тЭУ р╣Др╕бр╣Ир╣Ар╕Вр╣Йр╕▓р╣Гр╕Ир╕Др╕│р╕кр╕▒р╣Ир╕З");
    onCommand("UNKNOWN", command);
  };

  if (!isSupported) {
    return <div className="text-xs text-gray-500">р╣Ар╕Ър╕гр╕▓р╕зр╣Мр╣Ар╕Лр╕нр╕гр╣Мр╕Щр╕╡р╣Йр╣Др╕бр╣Ир╕гр╕нр╕Зр╕гр╕▒р╕Ър╕Бр╕▓р╕гр╕Др╕зр╕Ър╕Др╕╕р╕бр╕Фр╣Йр╕зр╕вр╣Ар╕кр╕╡р╕вр╕З</div>;
  }

  return (
    <div className="flex flex-col items-center space-y-2">
      <button
        onMouseDown={e => {
          console.log("ЁЯОд р╕Ыр╕╕р╣Ир╕бр╕Цр╕╣р╕Бр╕Бр╕Ф (onMouseDown)");
          e.preventDefault();
          startListening();
        }}
        onMouseUp={e => {
          console.log("ЁЯОд р╕Ыр╕╕р╣Ир╕бр╕Цр╕╣р╕Бр╕Ыр╕ер╣Ир╕нр╕в (onMouseUp)");
          e.preventDefault();
          stopListening();
        }}
        onMouseLeave={e => {
          console.log("ЁЯОд р╣Ар╕бр╕▓р╕кр╣Мр╕нр╕нр╕Бр╕Ир╕▓р╕Бр╕Ыр╕╕р╣Ир╕б (onMouseLeave)");
          e.preventDefault();
          stopListening();
        }}
        disabled={!isSupported}
        className={`w-10 h-10 rounded-full text-white text-lg transition-all duration-200 flex items-center justify-center shadow-md hover:shadow-lg ${
          isListening ? "bg-red-500 hover:bg-red-600 animate-pulse" : "bg-blue-500 hover:bg-blue-600"
        }`}
        title={isListening ? "р╕Бр╕│р╕ер╕▒р╕Зр╕Яр╕▒р╕З... (р╕Ыр╕ер╣Ир╕нр╕вр╣Ар╕Юр╕╖р╣Ир╕нр╕лр╕вр╕╕р╕Ф)" : "р╕Бр╕Фр╕Др╣Йр╕▓р╕Зр╣Ар╕Юр╕╖р╣Ир╕нр╕Юр╕╣р╕Фр╕Др╕│р╕кр╕▒р╣Ир╕З"}
      >
        ЁЯОд
      </button>

      <div className="text-xs text-center">
        <div className={isListening ? "text-red-600 font-medium animate-pulse" : "text-gray-600"}>
          {isListening ? "р╕Бр╕│р╕ер╕▒р╕Зр╕Яр╕▒р╕З..." : "р╕Бр╕Фр╕Др╣Йр╕▓р╕Зр╣Ар╕Юр╕╖р╣Ир╕нр╕Юр╕╣р╕Ф"}
        </div>
        {transcript && <div className="text-blue-600 font-medium mt-1">р╣Др╕Фр╣Йр╕вр╕┤р╕Щ: {transcript}</div>}
        {commandResult && (
          <div
            className={`font-medium mt-2 px-2 py-1 rounded text-xs ${
              commandResult.includes("тЬЕ")
                ? "bg-green-100 text-green-700"
                : commandResult.includes("тЭУ")
                ? "bg-yellow-100 text-yellow-700"
                : "bg-blue-100 text-blue-700"
            }`}
          >
            {commandResult}
          </div>
        )}
        {lastCommand && commandResult && <div className="text-gray-500 text-xs mt-1">р╕Др╕│р╕кр╕▒р╣Ир╕З: "{lastCommand}"</div>}
      </div>
    </div>
  );
};

export default VoiceControl;
